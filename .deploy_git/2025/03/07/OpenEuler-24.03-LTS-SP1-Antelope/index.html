<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>openEuler openstack Antelope 部署 | AccessOK</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">openEuler openstack Antelope 部署</h1><a id="logo" href="/.">AccessOK</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">openEuler openstack Antelope 部署</h1><div class="post-meta">2025-03-07<span> | </span><span class="category"><a href="/categories/Openstack/">Openstack</a><a href="/categories/Openstack/Actions/">Actions</a><a href="/categories/Openstack/Actions/Deploy/">Deploy</a></span></div><div class="post-content"><h1 id="OpenStack-Antelope-部署指南"><a href="#OpenStack-Antelope-部署指南" class="headerlink" title="OpenStack Antelope 部署指南"></a>OpenStack Antelope 部署指南</h1><p>[TOC]</p>
<p>本文档是 openEuler OpenStack SIG 编写的基于 |openEuler 24.03 LTS SP1 的 OpenStack 部署指南，内容由 SIG 贡献者提供。在阅读过程中，如果您有任何疑问或者发现任何问题，请<a target="_blank" rel="noopener" href="https://gitee.com/openeuler/openstack#%E8%81%94%E7%B3%BB%E6%96%B9%E5%BC%8F">联系</a>SIG维护人员，或者直接<a target="_blank" rel="noopener" href="https://gitee.com/openeuler/openstack/issues">提交issue</a></p>
<p><strong>约定</strong></p>
<p>本章节描述文档中的一些通用约定。</p>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">定义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">RABBIT_PASS</td>
<td align="center">rabbitmq的密码，由用户设置，在OpenStack各个服务配置中使用</td>
</tr>
<tr>
<td align="center">CINDER_PASS</td>
<td align="center">cinder服务keystone用户的密码，在cinder配置中使用</td>
</tr>
<tr>
<td align="center">CINDER_DBPASS</td>
<td align="center">cinder服务数据库密码，在cinder配置中使用</td>
</tr>
<tr>
<td align="center">KEYSTONE_DBPASS</td>
<td align="center">keystone服务数据库密码，在keystone配置中使用</td>
</tr>
<tr>
<td align="center">GLANCE_PASS</td>
<td align="center">glance服务keystone用户的密码，在glance配置中使用</td>
</tr>
<tr>
<td align="center">GLANCE_DBPASS</td>
<td align="center">glance服务数据库密码，在glance配置中使用</td>
</tr>
<tr>
<td align="center">HEAT_PASS</td>
<td align="center">在keystone注册的heat用户密码，在heat配置中使用</td>
</tr>
<tr>
<td align="center">HEAT_DBPASS</td>
<td align="center">heat服务数据库密码，在heat配置中使用</td>
</tr>
<tr>
<td align="center">CYBORG_PASS</td>
<td align="center">在keystone注册的cyborg用户密码，在cyborg配置中使用</td>
</tr>
<tr>
<td align="center">CYBORG_DBPASS</td>
<td align="center">cyborg服务数据库密码，在cyborg配置中使用</td>
</tr>
<tr>
<td align="center">NEUTRON_PASS</td>
<td align="center">在keystone注册的neutron用户密码，在neutron配置中使用</td>
</tr>
<tr>
<td align="center">NEUTRON_DBPASS</td>
<td align="center">neutron服务数据库密码，在neutron配置中使用</td>
</tr>
<tr>
<td align="center">PROVIDER_INTERFACE_NAME</td>
<td align="center">物理网络接口的名称，在neutron配置中使用</td>
</tr>
<tr>
<td align="center">OVERLAY_INTERFACE_IP_ADDRESS</td>
<td align="center">Controller控制节点的管理ip地址，在neutron配置中使用</td>
</tr>
<tr>
<td align="center">METADATA_SECRET</td>
<td align="center">metadata proxy的secret密码，在nova和neutron配置中使用</td>
</tr>
<tr>
<td align="center">PLACEMENT_DBPASS</td>
<td align="center">placement服务数据库密码，在placement配置中使用</td>
</tr>
<tr>
<td align="center">PLACEMENT_PASS</td>
<td align="center">在keystone注册的placement用户密码，在placement配置中使用</td>
</tr>
<tr>
<td align="center">NOVA_DBPASS</td>
<td align="center">nova服务数据库密码，在nova配置中使用</td>
</tr>
<tr>
<td align="center">NOVA_PASS</td>
<td align="center">在keystone注册的nova用户密码，在nova,cyborg,neutron等配置中使用</td>
</tr>
<tr>
<td align="center">IRONIC_DBPASS</td>
<td align="center">ironic服务数据库密码，在ironic配置中使用</td>
</tr>
<tr>
<td align="center">IRONIC_PASS</td>
<td align="center">在keystone注册的ironic用户密码，在ironic配置中使用</td>
</tr>
<tr>
<td align="center">IRONIC_INSPECTOR_DBPASS</td>
<td align="center">ironic-inspector服务数据库密码，在ironic-inspector配置中使用</td>
</tr>
<tr>
<td align="center">IRONIC_INSPECTOR_PASS</td>
<td align="center">在keystone注册的ironic-inspector用户密码，在ironic-inspector配置中使用</td>
</tr>
</tbody></table>
<p>OpenStack SIG 提供了多种基于 openEuler 部署 OpenStack 的方法，以满足不同的用户场景，请按需选择。</p>
<h2 id="基于RPM部署"><a href="#基于RPM部署" class="headerlink" title="基于RPM部署"></a>基于RPM部署</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>本文档基于OpenStack经典的三节点环境进行部署，三个节点分别是控制节点(Controller)、计算节点(Compute)、存储节点(Storage)，其中存储节点一般只部署存储服务，在资源有限的情况下，可以不单独部署该节点，把存储节点上的服务部署到计算节点即可。</p>
<p>首先准备三个|openEuler 24.03 LTS SP1环境，根据您的环境，下载对应的镜像并安装即可：<a target="_blank" rel="noopener" href="https://repo.openeuler.org/openEuler-24.03-LTS-SP1/ISO/">ISO镜像</a>、<a target="_blank" rel="noopener" href="https://repo.openeuler.org/openEuler-24.03-LTS-SP1/virtual_machine_img/">qcow2镜像</a>。</p>
<p>下面的安装按照如下拓扑进行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">controller：192.168.0.2</span><br><span class="line">compute：   192.168.0.3</span><br><span class="line">storage：   192.168.0.4</span><br></pre></td></tr></table></figure>

<p>如果您的环境IP不同，请按照您的环境IP修改相应的配置文件。</p>
<p>本文档的三节点服务拓扑如下图所示(只包含Keystone、Glance、Nova、Cinder、Neutron这几个核心服务，其他服务请参考具体部署章节)：</p>
<p><img src="/../img/install/topology1.PNG" alt="topology1"><br><img src="/../img/install/topology2.PNG" alt="topology2"><br><img src="/../img/install/topology3.PNG" alt="topology3"></p>
<p>在正式部署之前，需要对每个节点做如下配置和检查：</p>
<ol>
<li><p>配置 |openEuler 24.03 LTS SP1 官方 yum 源，需要启用 EPOL 软件仓以支持 OpenStack</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum update</span><br><span class="line">yum install openstack-release-antelope</span><br><span class="line">yum clean all &amp;&amp; yum makecache</span><br></pre></td></tr></table></figure>

<p> <strong>注意</strong>：如果你的环境的YUM源没有启用EPOL，需要同时配置EPOL，确保EPOL已配置，如下所示。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/yum.repos.d/openEuler.repo</span><br><span class="line"></span><br><span class="line">[EPOL]</span><br><span class="line">name=EPOL</span><br><span class="line">baseurl=http://repo.openeuler.org/openEuler-24.03-LTS-SP1/EPOL/main/$basearch/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.openeuler.org/openEuler-24.03-LTS-SP1/OS/$basearch/RPM-GPG-KEY-openEuler</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改主机名以及映射</p>
<p> 每个节点分别修改主机名，以controller为例：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname controller</span><br><span class="line"></span><br><span class="line">vi /etc/hostname</span><br><span class="line">内容修改为controller</span><br></pre></td></tr></table></figure>

<p> 然后修改每个节点的<code>/etc/hosts</code>文件，新增如下内容:</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.0.2   controller</span><br><span class="line">192.168.0.3   compute</span><br><span class="line">192.168.0.4   storage</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="时钟同步"><a href="#时钟同步" class="headerlink" title="时钟同步"></a>时钟同步</h4><p>集群环境时刻要求每个节点的时间一致，一般由时钟同步软件保证。本文使用<code>chrony</code>软件。步骤如下：</p>
<p><strong>Controller节点</strong>：</p>
<ol>
<li><p>安装服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install chrony</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>/etc/chrony.conf</code>配置文件，新增一行</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示允许哪些IP从本节点同步时钟</span></span><br><span class="line">allow 192.168.0.0/24</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart chronyd</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>其他节点</strong></p>
<ol>
<li><p>安装服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install chrony</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>/etc/chrony.conf</code>配置文件，新增一行</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NTP_SERVER是controller IP，表示从这个机器获取时间，这里我们填192.168.0.2，或者在`/etc/hosts`里配置好的controller名字即可。</span></span><br><span class="line">server NTP_SERVER iburst</span><br></pre></td></tr></table></figure>

<p> 同时，要把<code>pool pool.ntp.org iburst</code>这一行注释掉，表示不从公网同步时钟。</p>
</li>
<li><p>重启服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart chronyd</span><br></pre></td></tr></table></figure></li>
</ol>
<p>配置完成后，检查一下结果，在其他非controller节点执行<code>chronyc sources</code>，返回结果类似如下内容，表示成功从controller同步时钟。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last <span class="attr">sample</span></span><br><span class="line">===============================================================================</span><br><span class="line">^* 192.168.0.2                 4   6     7     0  -1406ns<span class="section">[  +55us]</span> +/-   16ms</span><br></pre></td></tr></table></figure>

<h4 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h4><p>数据库安装在控制节点，这里推荐使用mariadb。</p>
<ol>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install mysql-config mariadb mariadb-server python3-PyMySQL</span><br></pre></td></tr></table></figure>
</li>
<li><p>新增配置文件<code>/etc/my.cnf.d/openstack.cnf</code>，内容如下</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">bind-address = 192.168.0.2</span><br><span class="line">default-storage-engine = innodb</span><br><span class="line">innodb_file_per_table = on</span><br><span class="line">max_connections = 4096</span><br><span class="line">collation-server = utf8_general_ci</span><br><span class="line">character-set-server = utf8</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务器</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化数据库，根据提示进行即可</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure>

<p> 示例如下：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB</span><br><span class="line">    SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!</span><br><span class="line"></span><br><span class="line">In order to log into MariaDB to secure it, we&#x27;ll need the current</span><br><span class="line">password for the root user. If you&#x27;ve just installed MariaDB, and</span><br><span class="line">haven&#x27;t set the root password yet, you should just press enter here.</span><br><span class="line"></span><br><span class="line">Enter current password for root (enter for none): </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这里输入密码，由于我们是初始化DB，直接回车就行</span></span><br><span class="line"></span><br><span class="line">OK, successfully used password, moving on...</span><br><span class="line"></span><br><span class="line">Setting the root password or using the unix_socket ensures that nobody</span><br><span class="line">can log into the MariaDB root user without the proper authorisation.</span><br><span class="line"></span><br><span class="line">You already have your root account protected, so you can safely answer &#x27;n&#x27;.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里根据提示输入N</span></span><br><span class="line"></span><br><span class="line">Switch to unix_socket authentication [Y/n] N</span><br><span class="line"></span><br><span class="line">Enabled successfully!</span><br><span class="line">Reloading privilege tables..</span><br><span class="line">... Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You already have your root account protected, so you can safely answer &#x27;n&#x27;.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入Y，修改密码</span></span><br><span class="line"></span><br><span class="line">Change the root password? [Y/n] Y</span><br><span class="line"></span><br><span class="line">New password: </span><br><span class="line">Re-enter new password: </span><br><span class="line">Password updated successfully!</span><br><span class="line">Reloading privilege tables..</span><br><span class="line">... Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">By default, a MariaDB installation has an anonymous user, allowing anyone</span><br><span class="line">to log into MariaDB without having to have a user account created for</span><br><span class="line">them.  This is intended only for testing, and to make the installation</span><br><span class="line">go a bit smoother.  You should remove them before moving into a</span><br><span class="line">production environment.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入Y，删除匿名用户</span></span><br><span class="line"></span><br><span class="line">Remove anonymous users? [Y/n] Y</span><br><span class="line">... Success!</span><br><span class="line"></span><br><span class="line">Normally, root should only be allowed to connect from &#x27;localhost&#x27;.  This</span><br><span class="line">ensures that someone cannot guess at the root password from the network.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入Y，关闭root远程登录权限</span></span><br><span class="line"></span><br><span class="line">Disallow root login remotely? [Y/n] Y</span><br><span class="line">... Success!</span><br><span class="line"></span><br><span class="line">By default, MariaDB comes with a database named &#x27;test&#x27; that anyone can</span><br><span class="line">access.  This is also intended only for testing, and should be removed</span><br><span class="line">before moving into a production environment.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入Y，删除<span class="built_in">test</span>数据库</span></span><br><span class="line"></span><br><span class="line">Remove test database and access to it? [Y/n] Y</span><br><span class="line">- Dropping test database...</span><br><span class="line">... Success!</span><br><span class="line">- Removing privileges on test database...</span><br><span class="line">... Success!</span><br><span class="line"></span><br><span class="line">Reloading the privilege tables will ensure that all changes made so far</span><br><span class="line">will take effect immediately.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入Y，重载配置</span></span><br><span class="line"></span><br><span class="line">Reload privilege tables now? [Y/n] Y</span><br><span class="line">... Success!</span><br><span class="line"></span><br><span class="line">Cleaning up...</span><br><span class="line"></span><br><span class="line">All done!  If you&#x27;ve completed all of the above steps, your MariaDB</span><br><span class="line">installation should now be secure.</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证，根据第四步设置的密码，检查是否能登录mariadb</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="安装消息队列"><a href="#安装消息队列" class="headerlink" title="安装消息队列"></a>安装消息队列</h4><p>消息队列安装在控制节点，这里推荐使用rabbitmq。</p>
<ol>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install rabbitmq-server</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start rabbitmq-server</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置openstack用户，<code>RABBIT_PASS</code>是openstack服务登录消息队里的密码，需要和后面各个服务的配置保持一致。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user openstack RABBIT_PASS</span><br><span class="line">rabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="安装缓存服务"><a href="#安装缓存服务" class="headerlink" title="安装缓存服务"></a>安装缓存服务</h4><p>消息队列安装在控制节点，这里推荐使用Memcached。</p>
<ol>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install memcached python3-memcached</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件<code>/etc/sysconfig/memcached</code></p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS=&quot;-l 127.0.0.1,::1,controller&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start memcached</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="部署服务"><a href="#部署服务" class="headerlink" title="部署服务"></a>部署服务</h3><h4 id="Keystone"><a href="#Keystone" class="headerlink" title="Keystone"></a>Keystone</h4><p>Keystone是OpenStack提供的鉴权服务，是整个OpenStack的入口，提供了租户隔离、用户认证、服务发现等功能，必须安装。</p>
<ol>
<li><p>创建 keystone 数据库并授权</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE keystone;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> keystone.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;keystone&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> \</span><br><span class="line">IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;KEYSTONE_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> keystone.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;keystone&#x27;</span>@<span class="string">&#x27;%&#x27;</span> \</span><br><span class="line">IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;KEYSTONE_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> exit</span><br></pre></td></tr></table></figure>

<p> <em><strong>注意</strong></em></p>
<p> <strong>替换 <code>KEYSTONE_DBPASS</code>，为 Keystone 数据库设置密码</strong></p>
</li>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-keystone httpd mod_wsgi</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置keystone相关配置</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keystone/keystone.conf</span><br><span class="line"></span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone</span><br><span class="line"></span><br><span class="line">[token]</span><br><span class="line">provider = fernet</span><br></pre></td></tr></table></figure>

<p> <em><strong>解释</strong></em></p>
<p> [database]部分，配置数据库入口</p>
<p> [token]部分，配置token provider</p>
</li>
<li><p>同步数据库</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;keystone-manage db_sync&quot; keystone</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化Fernet密钥仓库</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone</span><br><span class="line">keystone-manage credential_setup --keystone-user keystone --keystone-group keystone</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keystone-manage bootstrap --bootstrap-password ADMIN_PASS \</span><br><span class="line">--bootstrap-admin-url http://controller:5000/v3/ \</span><br><span class="line">--bootstrap-internal-url http://controller:5000/v3/ \</span><br><span class="line">--bootstrap-public-url http://controller:5000/v3/ \</span><br><span class="line">--bootstrap-region-id RegionOne</span><br></pre></td></tr></table></figure>

<p> <em><strong>注意</strong></em></p>
<p> <strong>替换 <code>ADMIN_PASS</code>，为 admin 用户设置密码</strong></p>
</li>
<li><p>配置Apache HTTP server</p>
<ul>
<li>打开httpd.conf并配置</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">需要修改的配置文件路径</span></span><br><span class="line">vim /etc/httpd/conf/httpd.conf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">修改以下项，如果没有则新添加</span></span><br><span class="line">ServerName controller</span><br></pre></td></tr></table></figure>

<ul>
<li>创建软链接</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/</span><br></pre></td></tr></table></figure>

<p> <em><strong>解释</strong></em></p>
<p> 配置 <code>ServerName</code> 项引用控制节点</p>
<p> <em><strong>注意</strong></em><br> <strong>如果 <code>ServerName</code> 项不存在则需要创建</strong></p>
</li>
<li><p>启动Apache HTTP服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable httpd.service</span><br><span class="line">systemctl start httpd.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建环境变量配置</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt;&gt; ~/.admin-openrc</span><br><span class="line">export OS_PROJECT_DOMAIN_NAME=Default</span><br><span class="line">export OS_USER_DOMAIN_NAME=Default</span><br><span class="line">export OS_PROJECT_NAME=admin</span><br><span class="line">export OS_USERNAME=admin</span><br><span class="line">export OS_PASSWORD=ADMIN_PASS</span><br><span class="line">export OS_AUTH_URL=http://controller:5000/v3</span><br><span class="line">export OS_IDENTITY_API_VERSION=3</span><br><span class="line">export OS_IMAGE_API_VERSION=2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p> <em><strong>注意</strong></em></p>
<p> <strong>替换 <code>ADMIN_PASS</code> 为 admin 用户的密码</strong></p>
</li>
<li><p>依次创建domain, projects, users, roles</p>
<ul>
<li>需要先安装python3-openstackclient</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install python3-openstackclient</span><br></pre></td></tr></table></figure>

<ul>
<li>导入环境变量</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br></pre></td></tr></table></figure>

<ul>
<li>创建project <code>service</code>，其中 domain <code>default</code> 在 keystone-manage bootstrap 时已创建</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack domain create --description &quot;An Example Domain&quot; example</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack project create --domain default --description &quot;Service Project&quot; service</span><br></pre></td></tr></table></figure>

<ul>
<li>创建（non-admin）project <code>myproject</code>，user <code>myuser</code> 和 role <code>myrole</code>，为 <code>myproject</code> 和 <code>myuser</code> 添加角色<code>myrole</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack project create --domain default --description &quot;Demo Project&quot; myproject</span><br><span class="line">openstack user create --domain default --password-prompt myuser</span><br><span class="line">openstack role create myrole</span><br><span class="line">openstack role add --project myproject --user myuser myrole</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证</p>
<ul>
<li>取消临时环境变量OS_AUTH_URL和OS_PASSWORD：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br><span class="line">unset OS_AUTH_URL OS_PASSWORD</span><br></pre></td></tr></table></figure>

<ul>
<li>为admin用户请求token：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack --os-auth-url http://controller:5000/v3 \</span><br><span class="line">--os-project-domain-name Default --os-user-domain-name Default \</span><br><span class="line">--os-project-name admin --os-username admin token issue</span><br></pre></td></tr></table></figure>

<ul>
<li>为myuser用户请求token：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack --os-auth-url http://controller:5000/v3 \</span><br><span class="line">--os-project-domain-name Default --os-user-domain-name Default \</span><br><span class="line">--os-project-name myproject --os-username myuser token issue</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Glance"><a href="#Glance" class="headerlink" title="Glance"></a>Glance</h4><p>Glance是OpenStack提供的镜像服务，负责虚拟机、裸机镜像的上传与下载，必须安装。</p>
<p><strong>Controller节点</strong>：</p>
<ol>
<li><p>创建 glance 数据库并授权</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE glance;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> glance.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;glance&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> \</span><br><span class="line">IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;GLANCE_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> glance.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;glance&#x27;</span>@<span class="string">&#x27;%&#x27;</span> \</span><br><span class="line">IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;GLANCE_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> exit</span><br></pre></td></tr></table></figure>

<p> <em><strong>注意:</strong></em></p>
<p> <strong>替换 <code>GLANCE_DBPASS</code>，为 glance 数据库设置密码</strong></p>
</li>
<li><p>初始化 glance 资源对象</p>
<ul>
<li>导入环境变量</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br></pre></td></tr></table></figure>

<ul>
<li>创建用户时，命令行会提示输入密码，请输入自定义的密码，下文涉及到<code>GLANCE_PASS</code>的地方替换成该密码即可。</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password-prompt glance</span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br></pre></td></tr></table></figure>

<ul>
<li>添加glance用户到service project并指定admin角色：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add --project service --user glance admin</span><br></pre></td></tr></table></figure>

<ul>
<li>创建glance服务实体：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack service create --name glance --description &quot;OpenStack Image&quot; image</span><br></pre></td></tr></table></figure>

<ul>
<li>创建glance API服务：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne image public http://controller:9292</span><br><span class="line">openstack endpoint create --region RegionOne image internal http://controller:9292</span><br><span class="line">openstack endpoint create --region RegionOne image admin http://controller:9292</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-glance</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 glance 配置文件</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/glance/glance-api.conf</span><br><span class="line"></span><br><span class="line">[database]</span><br><span class="line">connection = mysql+pymysql://glance:GLANCE_DBPASS@controller/glance</span><br><span class="line"></span><br><span class="line">[keystone_authtoken]</span><br><span class="line">www_authenticate_uri  = http://controller:5000</span><br><span class="line">auth_url = http://controller:5000</span><br><span class="line">memcached_servers = controller:11211</span><br><span class="line">auth_type = password</span><br><span class="line">project_domain_name = Default</span><br><span class="line">user_domain_name = Default</span><br><span class="line">project_name = service</span><br><span class="line">username = glance</span><br><span class="line">password = GLANCE_PASS</span><br><span class="line"></span><br><span class="line">[paste_deploy]</span><br><span class="line">flavor = keystone</span><br><span class="line"></span><br><span class="line">[glance_store]</span><br><span class="line">stores = file,http</span><br><span class="line">default_store = file</span><br><span class="line">filesystem_store_datadir = /var/lib/glance/images/</span><br></pre></td></tr></table></figure>

<p> <em><strong>解释:</strong></em></p>
<p> [database]部分，配置数据库入口</p>
<p> [keystone_authtoken] [paste_deploy]部分，配置身份认证服务入口</p>
<p> [glance_store]部分，配置本地文件系统存储和镜像文件的位置</p>
</li>
<li><p>同步数据库</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;glance-manage db_sync&quot; glance</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openstack-glance-api.service</span><br><span class="line">systemctl start openstack-glance-api.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证</p>
<ul>
<li>导入环境变量</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrcu</span><br></pre></td></tr></table></figure>

<ul>
<li>下载镜像</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x86镜像下载：</span><br><span class="line">wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img</span><br><span class="line"></span><br><span class="line">arm镜像下载：</span><br><span class="line">wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-aarch64-disk.img</span><br></pre></td></tr></table></figure>

<p> <em><strong>注意</strong></em></p>
<p> <strong>如果您使用的环境是鲲鹏架构，请下载aarch64版本的镜像；已对镜像cirros-0.5.2-aarch64-disk.img进行测试。</strong></p>
<ul>
<li>向Image服务上传镜像：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack image create --disk-format qcow2 --container-format bare \</span><br><span class="line">                    --file cirros-0.4.0-x86_64-disk.img --public cirros</span><br></pre></td></tr></table></figure>

<ul>
<li>确认镜像上传并验证属性：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack image list</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Placement"><a href="#Placement" class="headerlink" title="Placement"></a>Placement</h4><p>Placement是OpenStack提供的资源调度组件，一般不面向用户，由Nova等组件调用，安装在控制节点。</p>
<p>安装、配置Placement服务前，需要先创建相应的数据库、服务凭证和API endpoints。</p>
<ol>
<li><p>创建数据库</p>
<ul>
<li>使用root用户访问数据库服务：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>

<ul>
<li>创建placement数据库：</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE placement;</span><br></pre></td></tr></table></figure>

<ul>
<li>授权数据库访问：</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> placement.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;placement&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> \</span><br><span class="line">    IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;PLACEMENT_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> placement.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;placement&#x27;</span>@<span class="string">&#x27;%&#x27;</span> \</span><br><span class="line">    IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;PLACEMENT_DBPASS&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p> 替换<code>PLACEMENT_DBPASS</code>为placement数据库访问密码。</p>
<ul>
<li>退出数据库访问客户端：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置用户和Endpoints</p>
<ul>
<li>source admin凭证，以获取admin命令行权限：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br></pre></td></tr></table></figure>

<ul>
<li>创建placement用户并设置用户密码：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password-prompt placement</span><br><span class="line"></span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br></pre></td></tr></table></figure>

<ul>
<li>添加placement用户到service project并指定admin角色：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add --project service --user placement admin</span><br></pre></td></tr></table></figure>

<ul>
<li>创建placement服务实体：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack service create --name placement \</span><br><span class="line">    --description &quot;Placement API&quot; placement</span><br></pre></td></tr></table></figure>

<ul>
<li>创建Placement API服务endpoints：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">    placement public http://controller:8778</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">    placement internal http://controller:8778</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">    placement admin http://controller:8778</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装及配置组件</p>
<ul>
<li>安装软件包：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-placement-api</span><br></pre></td></tr></table></figure>

<ul>
<li><p>编辑<code>/etc/placement/placement.conf</code>配置文件，完成如下操作：</p>
<ul>
<li>在<code>[placement_database]</code>部分，配置数据库入口：</li>
</ul>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[placement_database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://placement:PLACEMENT_DBPASS@controller/placement</span><br></pre></td></tr></table></figure>

<p>  替换<code>PLACEMENT_DBPASS</code>为placement数据库的密码。</p>
<ul>
<li>在<code>[api]</code>和<code>[keystone_authtoken]</code>部分，配置身份认证服务入口：</li>
</ul>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">memcached_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = placement</span><br><span class="line"><span class="attr">password</span> = PLACEMENT_PASS</span><br></pre></td></tr></table></figure>

<p>  替换<code>PLACEMENT_PASS</code>为placement用户的密码。</p>
</li>
<li><p>数据库同步，填充Placement数据库：</p>
</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;placement-manage db sync&quot; placement</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务</p>
<p> 重启httpd服务：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证</p>
<ul>
<li>source admin凭证，以获取admin命令行权限</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br></pre></td></tr></table></figure>

<ul>
<li>执行状态检查：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">placement-status upgrade check</span><br></pre></td></tr></table></figure>

 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------------------------------------------+</span><br><span class="line">| Upgrade Check Results                                                |</span><br><span class="line">+----------------------------------------------------------------------+</span><br><span class="line">| Check: Missing Root Provider IDs                                     |</span><br><span class="line">| Result: Success                                                      |</span><br><span class="line">| Details: None                                                        |</span><br><span class="line">+----------------------------------------------------------------------+</span><br><span class="line">| Check: Incomplete Consumers                                          |</span><br><span class="line">| Result: Success                                                      |</span><br><span class="line">| Details: None                                                        |</span><br><span class="line">+----------------------------------------------------------------------+</span><br><span class="line">| Check: Policy File JSON to YAML Migration                            |</span><br><span class="line">| Result: Failure                                                      |</span><br><span class="line">| Details: Your policy file is JSON-formatted which is deprecated. You |</span><br><span class="line">|   need to switch to YAML-formatted file. Use the                     |</span><br><span class="line">|   ``oslopolicy-convert-json-to-yaml`` tool to convert the            |</span><br><span class="line">|   existing JSON-formatted files to YAML in a backwards-              |</span><br><span class="line">|   compatible manner: https://docs.openstack.org/oslo.policy/         |</span><br><span class="line">|   latest/cli/oslopolicy-convert-json-to-yaml.html.                   |</span><br><span class="line">+----------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p> 这里可以看到<code>Policy File JSON to YAML Migration</code>的结果为Failure。这是因为在Placement中，JSON格式的policy文件从Wallaby版本开始已处于<code>deprecated</code>状态。可以参考提示，使用<a target="_blank" rel="noopener" href="https://docs.openstack.org/oslo.policy/latest/cli/oslopolicy-convert-json-to-yaml.html">oslopolicy-convert-json-to-yaml</a>工具  将现有的JSON格式policy文件转化为YAML格式。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">oslopolicy-convert-json-to-yaml  --namespace placement \</span><br><span class="line">    --policy-file /etc/placement/policy.json \</span><br><span class="line">    --output-file /etc/placement/policy.yaml</span><br><span class="line">mv /etc/placement/policy.json&#123;,.bak&#125;</span><br></pre></td></tr></table></figure>

<p> 注：当前环境中此问题可忽略，不影响运行。</p>
<ul>
<li><p>针对placement API运行命令：</p>
<ul>
<li>安装osc-placement插件：</li>
</ul>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install python3-osc-placement</span><br></pre></td></tr></table></figure>

<ul>
<li>列出可用的资源类别及特性：</li>
</ul>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">openstack --os-placement-api-version 1.2 resource class list --sort-column name</span><br><span class="line">+----------------------------+</span><br><span class="line">| name                       |</span><br><span class="line">+----------------------------+</span><br><span class="line">| DISK_GB                    |</span><br><span class="line">| FPGA                       |</span><br><span class="line">| ...                        |</span><br><span class="line"></span><br><span class="line">openstack --os-placement-api-version 1.6 trait list --sort-column name</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| name                                  |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| COMPUTE_ACCELERATORS                  |</span><br><span class="line">| COMPUTE_ARCH_AARCH64                  |</span><br><span class="line">| ...                                   |</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h4 id="Nova"><a href="#Nova" class="headerlink" title="Nova"></a>Nova</h4><p>Nova是OpenStack的计算服务，负责虚拟机的创建、发放等功能。</p>
<p><strong>Controller节点</strong></p>
<p>在控制节点执行以下操作。</p>
<ol>
<li><p>创建数据库</p>
<ul>
<li>使用root用户访问数据库服务：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>

<ul>
<li>创建<code>nova_api</code>、<code>nova</code>和<code>nova_cell0</code>数据库：</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE nova_api;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE nova;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE nova_cell0;</span><br></pre></td></tr></table></figure>

<ul>
<li>授权数据库访问：</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova_api.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> \</span><br><span class="line">    IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova_api.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;%&#x27;</span> \</span><br><span class="line">    IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> \</span><br><span class="line">    IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;%&#x27;</span> \</span><br><span class="line">    IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova_cell0.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> \</span><br><span class="line">    IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> nova_cell0.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;nova&#x27;</span>@<span class="string">&#x27;%&#x27;</span> \</span><br><span class="line">    IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;NOVA_DBPASS&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p> 替换<code>NOVA_DBPASS</code>为nova相关数据库访问密码。</p>
<ul>
<li>退出数据库访问客户端：</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置用户和Endpoints</p>
<ul>
<li>source admin凭证，以获取admin命令行权限：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br></pre></td></tr></table></figure>

<ul>
<li>创建nova用户并设置用户密码：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password-prompt nova</span><br><span class="line"></span><br><span class="line">User Password:</span><br><span class="line">Repeat User Password:</span><br></pre></td></tr></table></figure>

<ul>
<li>添加nova用户到service project并指定admin角色：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add --project service --user nova admin</span><br></pre></td></tr></table></figure>

<ul>
<li>创建nova服务实体：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack service create --name nova \</span><br><span class="line">    --description &quot;OpenStack Compute&quot; compute</span><br></pre></td></tr></table></figure>

<ul>
<li>创建Nova API服务endpoints：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">    compute public http://controller:8774/v2.1</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">    compute internal http://controller:8774/v2.1</span><br><span class="line">openstack endpoint create --region RegionOne \</span><br><span class="line">    compute admin http://controller:8774/v2.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装及配置组件</p>
<ul>
<li>安装软件包：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-nova-api openstack-nova-conductor \</span><br><span class="line">    openstack-nova-novncproxy openstack-nova-scheduler</span><br></pre></td></tr></table></figure>

<ul>
<li><p>编辑<code>/etc/nova/nova.conf</code>配置文件，完成如下操作：</p>
<ul>
<li>在<code>[default]</code>部分，启用计算和元数据的API，配置RabbitMQ消息队列入口，使用controller节点管理IP配置my_ip，显式定义log_dir：</li>
</ul>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">enabled_apis</span> = osapi_compute,metadata</span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br><span class="line"><span class="attr">my_ip</span> = <span class="number">192.168</span>.<span class="number">0.2</span></span><br><span class="line"><span class="attr">log_dir</span> = /var/log/nova</span><br><span class="line"><span class="attr">state_path</span> = /var/lib/nova</span><br></pre></td></tr></table></figure>

<p>  替换<code>RABBIT_PASS</code>为RabbitMQ中openstack账户的密码。</p>
<ul>
<li>在<code>[api_database]</code>和<code>[database]</code>部分，配置数据库入口：</li>
</ul>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[api_database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api</span><br><span class="line"></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://nova:NOVA_DBPASS@controller/nova</span><br></pre></td></tr></table></figure>

<p>  替换<code>NOVA_DBPASS</code>为nova相关数据库的密码。</p>
<ul>
<li>在<code>[api]</code>和<code>[keystone_authtoken]</code>部分，配置身份认证服务入口：</li>
</ul>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">memcached_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = nova</span><br><span class="line"><span class="attr">password</span> = NOVA_PASS</span><br></pre></td></tr></table></figure>

<p>  替换<code>NOVA_PASS</code>为nova用户的密码。</p>
<ul>
<li>在<code>[vnc]</code>部分，启用并配置远程控制台入口：</li>
</ul>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[vnc]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">server_listen</span> = <span class="variable">$my_ip</span></span><br><span class="line"><span class="attr">server_proxyclient_address</span> = <span class="variable">$my_ip</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>[glance]</code>部分，配置镜像服务API的地址：</li>
</ul>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[glance]</span></span><br><span class="line"><span class="attr">api_servers</span> = http://controller:<span class="number">9292</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>[oslo_concurrency]</code>部分，配置lock path：</li>
</ul>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[oslo_concurrency]</span></span><br><span class="line"><span class="attr">lock_path</span> = /var/lib/nova/tmp</span><br></pre></td></tr></table></figure>

<ul>
<li>[placement]部分，配置placement服务的入口：</li>
</ul>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[placement]</span></span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">username</span> = placement</span><br><span class="line"><span class="attr">password</span> = PLACEMENT_PASS</span><br></pre></td></tr></table></figure>

<p>  替换<code>PLACEMENT_PASS</code>为placement用户的密码。</p>
</li>
<li><p>数据库同步：</p>
<ul>
<li>同步nova-api数据库：</li>
</ul>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova</span><br></pre></td></tr></table></figure>

<ul>
<li>注册cell0数据库：</li>
</ul>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 map_cell0&quot; nova</span><br></pre></td></tr></table></figure>

<ul>
<li>创建cell1 cell：</li>
</ul>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 create_cell --name=cell1 --verbose&quot; nova</span><br></pre></td></tr></table></figure>

<ul>
<li>同步nova数据库：</li>
</ul>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;nova-manage db sync&quot; nova</span><br></pre></td></tr></table></figure>

<ul>
<li>验证cell0和cell1注册正确：</li>
</ul>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 list_cells&quot; nova</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>启动服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable \</span><br><span class="line">  openstack-nova-api.service \</span><br><span class="line">  openstack-nova-scheduler.service \</span><br><span class="line">  openstack-nova-conductor.service \</span><br><span class="line">  openstack-nova-novncproxy.service</span><br><span class="line"></span><br><span class="line">systemctl start \</span><br><span class="line">  openstack-nova-api.service \</span><br><span class="line">  openstack-nova-scheduler.service \</span><br><span class="line">  openstack-nova-conductor.service \</span><br><span class="line">  openstack-nova-novncproxy.service</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>Compute节点</strong></p>
<p>在计算节点执行以下操作。</p>
<ol>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-nova-compute</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑<code>/etc/nova/nova.conf</code>配置文件</p>
<ul>
<li>在<code>[default]</code>部分，启用计算和元数据的API，配置RabbitMQ消息队列入口，使用Compute节点管理IP配置my_ip，显式定义compute_driver、instances_path、log_dir：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">enabled_apis</span> = osapi_compute,metadata</span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br><span class="line"><span class="attr">my_ip</span> = <span class="number">192.168</span>.<span class="number">0.3</span></span><br><span class="line"><span class="attr">compute_driver</span> = libvirt.LibvirtDriver</span><br><span class="line"><span class="attr">instances_path</span> = /var/lib/nova/instances</span><br><span class="line"><span class="attr">log_dir</span> = /var/log/nova</span><br></pre></td></tr></table></figure>

<p> 替换<code>RABBIT_PASS</code>为RabbitMQ中openstack账户的密码。</p>
<ul>
<li>在<code>[api]</code>和<code>[keystone_authtoken]</code>部分，配置身份认证服务入口：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">memcached_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = nova</span><br><span class="line"><span class="attr">password</span> = NOVA_PASS</span><br></pre></td></tr></table></figure>

<p> 替换<code>NOVA_PASS</code>为nova用户的密码。</p>
<ul>
<li>在<code>[vnc]</code>部分，启用并配置远程控制台入口：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[vnc]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">server_listen</span> = <span class="variable">$my_ip</span></span><br><span class="line"><span class="attr">server_proxyclient_address</span> = <span class="variable">$my_ip</span></span><br><span class="line"><span class="attr">novncproxy_base_url</span> = http://controller:<span class="number">6080</span>/vnc_auto.html</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>[glance]</code>部分，配置镜像服务API的地址：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[glance]</span></span><br><span class="line"><span class="attr">api_servers</span> = http://controller:<span class="number">9292</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>[oslo_concurrency]</code>部分，配置lock path：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[oslo_concurrency]</span></span><br><span class="line"><span class="attr">lock_path</span> = /var/lib/nova/tmp</span><br></pre></td></tr></table></figure>

<ul>
<li>[placement]部分，配置placement服务的入口：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[placement]</span></span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">username</span> = placement</span><br><span class="line"><span class="attr">password</span> = PLACEMENT_PASS</span><br></pre></td></tr></table></figure>

<p> 替换<code>PLACEMENT_PASS</code>为placement用户的密码。</p>
</li>
<li><p>确认计算节点是否支持虚拟机硬件加速（x86_64）</p>
<p> 处理器为x86_64架构时，可通过运行如下命令确认是否支持硬件加速：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">egrep -c &#x27;(vmx|svm)&#x27; /proc/cpuinfo</span><br></pre></td></tr></table></figure>

<p> 如果返回值为0则不支持硬件加速，需要配置libvirt使用QEMU而不是默认的KVM。编辑<code>/etc/nova/nova.conf</code>的<code>[libvirt]</code>部分：</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[libvirt]</span></span><br><span class="line"><span class="attr">virt_type</span> = qemu</span><br></pre></td></tr></table></figure>

<p> 如果返回值为1或更大的值，则支持硬件加速，不需要进行额外的配置。</p>
</li>
<li><p>确认计算节点是否支持虚拟机硬件加速（arm64）</p>
<p> 处理器为arm64架构时，可通过运行如下命令确认是否支持硬件加速：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">virt-host-validate</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令由libvirt提供，此时libvirt应已作为openstack-nova-compute依赖被安装，环境中已有此命令</span></span><br></pre></td></tr></table></figure>

<p> 显示FAIL时，表示不支持硬件加速，需要配置libvirt使用QEMU而不是默认的KVM。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QEMU: Checking if device /dev/kvm exists: FAIL (Check that CPU and firmware supports virtualization and kvm module is loaded)</span><br></pre></td></tr></table></figure>

<p> 编辑<code>/etc/nova/nova.conf</code>的<code>[libvirt]</code>部分：</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[libvirt]</span></span><br><span class="line"><span class="attr">virt_type</span> = qemu</span><br></pre></td></tr></table></figure>

<p> 显示PASS时，表示支持硬件加速，不需要进行额外的配置。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QEMU: Checking if device /dev/kvm exists: PASS</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置qemu（仅arm64）</p>
<p> 仅当处理器为arm64架构时需要执行此操作。</p>
<ul>
<li>编辑<code>/etc/libvirt/qemu.conf</code>:</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nvram</span> = [<span class="string">&quot;/usr/share/AAVMF/AAVMF_CODE.fd: \</span></span><br><span class="line"><span class="string">            /usr/share/AAVMF/AAVMF_VARS.fd&quot;</span>, \</span><br><span class="line">            <span class="string">&quot;/usr/share/edk2/aarch64/QEMU_EFI-pflash.raw: \</span></span><br><span class="line"><span class="string">            /usr/share/edk2/aarch64/vars-template-pflash.raw&quot;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>编辑<code>/etc/qemu/firmware/edk2-aarch64.json</code></li>
</ul>
 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UEFI firmware for ARM64 virtual machines&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;interface-types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;uefi&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mapping&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;device&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flash&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;executable&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/share/edk2/aarch64/QEMU_EFI-pflash.raw&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;raw&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;nvram-template&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/share/edk2/aarch64/vars-template-pflash.raw&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;raw&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;aarch64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;machines&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;virt-*&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;features&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable libvirtd.service openstack-nova-compute.service</span><br><span class="line">systemctl start libvirtd.service openstack-nova-compute.service</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>Controller节点</strong></p>
<p>在控制节点执行以下操作。</p>
<ol>
<li><p>添加计算节点到openstack集群</p>
<ul>
<li>source admin凭证，以获取admin命令行权限：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br></pre></td></tr></table></figure>

<ul>
<li>确认nova-compute服务已识别到数据库中：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack compute service list --service nova-compute</span><br></pre></td></tr></table></figure>

<ul>
<li>发现计算节点，将计算节点添加到cell数据库：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova</span><br></pre></td></tr></table></figure>

<p> 结果如下：</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Modules with known eventlet monkey patching issues were imported prior to eventlet monkey patching: urllib3. This warning can usually be    ignored if the caller is only importing and not executing nova code.</span><br><span class="line">Found 2 cell mappings.</span><br><span class="line">Skipping cell0 since it does not contain hosts.</span><br><span class="line">Getting computes from cell &#x27;cell1&#x27;: 6dae034e-b2d9-4a6c-b6f0-60ada6a6ddc2</span><br><span class="line">Checking host mapping for compute host &#x27;compute&#x27;: 6286a86f-09d7-4786-9137-1185654c9e2e</span><br><span class="line">Creating host mapping for compute host &#x27;compute&#x27;: 6286a86f-09d7-4786-9137-1185654c9e2e</span><br><span class="line">Found 1 unmapped computes in cell: 6dae034e-b2d9-4a6c-b6f0-60ada6a6ddc2</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证</p>
<ul>
<li>列出服务组件，验证每个流程都成功启动和注册：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack compute service list</span><br></pre></td></tr></table></figure>

<ul>
<li>列出身份服务中的API端点，验证与身份服务的连接：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack catalog list</span><br></pre></td></tr></table></figure>

<ul>
<li>列出镜像服务中的镜像，验证与镜像服务的连接：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack image list</span><br></pre></td></tr></table></figure>

<ul>
<li>检查cells是否运作成功，以及其他必要条件是否已具备。</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nova-status upgrade check</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Neutron"><a href="#Neutron" class="headerlink" title="Neutron"></a>Neutron</h4><p>Neutron是OpenStack的网络服务，提供虚拟交换机、IP路由、DHCP等功能。</p>
<p><strong>Controller节点</strong></p>
<ol>
<li><p>创建数据库、服务凭证和 API 服务端点</p>
<ul>
<li>创建数据库：</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE neutron;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> neutron.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;neutron&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;NEUTRON_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> neutron.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;neutron&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;NEUTRON_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> exit;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建用户和服务，并记住创建neutron用户时输入的密码，用于配置NEUTRON_PASS：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br><span class="line">openstack user create --domain default --password-prompt neutron</span><br><span class="line">openstack role add --project service --user neutron admin</span><br><span class="line">openstack service create --name neutron --description &quot;OpenStack Networking&quot; network</span><br></pre></td></tr></table></figure>

<ul>
<li>部署 Neutron API 服务：</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne network public http://controller:9696</span><br><span class="line">openstack endpoint create --region RegionOne network internal http://controller:9696</span><br><span class="line">openstack endpoint create --region RegionOne network admin http://controller:9696</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y openstack-neutron openstack-neutron-linuxbridge ebtables ipset openstack-neutron-ml2</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Neutron</p>
<ul>
<li>修改&#x2F;etc&#x2F;neutron&#x2F;neutron.conf</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron</span><br><span class="line"></span><br><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">core_plugin</span> = ml2</span><br><span class="line"><span class="attr">service_plugins</span> = router</span><br><span class="line"><span class="attr">allow_overlapping_ips</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller</span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"><span class="attr">notify_nova_on_port_status_changes</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">notify_nova_on_port_data_changes</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">memcached_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = neutron</span><br><span class="line"><span class="attr">password</span> = NEUTRON_PASS</span><br><span class="line"></span><br><span class="line"><span class="section">[nova]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = nova</span><br><span class="line"><span class="attr">password</span> = NOVA_PASS</span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_concurrency]</span></span><br><span class="line"><span class="attr">lock_path</span> = /var/lib/neutron/tmp</span><br><span class="line"></span><br><span class="line"><span class="section">[experimental]</span></span><br><span class="line"><span class="attr">linuxbridge</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>配置ML2，ML2具体配置可以根据用户需求自行修改，本文使用的是provider network + linuxbridge**</p>
</li>
<li><p>修改&#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini</p>
</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[ml2]</span><br><span class="line">type_drivers = flat,vlan,vxlan</span><br><span class="line">tenant_network_types = vxlan</span><br><span class="line">mechanism_drivers = linuxbridge,l2population</span><br><span class="line">extension_drivers = port_security</span><br><span class="line"></span><br><span class="line">[ml2_type_flat]</span><br><span class="line">flat_networks = provider</span><br><span class="line"></span><br><span class="line">[ml2_type_vxlan]</span><br><span class="line">vni_ranges = 1:1000</span><br><span class="line"></span><br><span class="line">[securitygroup]</span><br><span class="line">enable_ipset = true</span><br></pre></td></tr></table></figure>

<ul>
<li>修改&#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[linux_bridge]</span></span><br><span class="line"><span class="attr">physical_interface_mappings</span> = provider:PROVIDER_INTERFACE_NAME</span><br><span class="line"></span><br><span class="line"><span class="section">[vxlan]</span></span><br><span class="line"><span class="attr">enable_vxlan</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">local_ip</span> = OVERLAY_INTERFACE_IP_ADDRESS</span><br><span class="line"><span class="attr">l2_population</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[securitygroup]</span></span><br><span class="line"><span class="attr">enable_security_group</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">firewall_driver</span> = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br></pre></td></tr></table></figure>

<ul>
<li><p>配置Layer-3代理</p>
</li>
<li><p>修改&#x2F;etc&#x2F;neutron&#x2F;l3_agent.ini</p>
</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">interface_driver = linuxbridge</span><br></pre></td></tr></table></figure>

<p> 配置DHCP代理<br> 修改&#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">interface_driver</span> = linuxbridge</span><br><span class="line"><span class="attr">dhcp_driver</span> = neutron.agent.linux.dhcp.Dnsmasq</span><br><span class="line"><span class="attr">enable_isolated_metadata</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>配置metadata代理</p>
</li>
<li><p>修改&#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini</p>
</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">nova_metadata_host = controller</span><br><span class="line">metadata_proxy_shared_secret = METADATA_SECRET</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置nova服务使用neutron，修改&#x2F;etc&#x2F;nova&#x2F;nova.conf</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[neutron]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = default</span><br><span class="line"><span class="attr">user_domain_name</span> = default</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = neutron</span><br><span class="line"><span class="attr">password</span> = NEUTRON_PASS</span><br><span class="line"><span class="attr">service_metadata_proxy</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">metadata_proxy_shared_secret</span> = METADATA_SECRET</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建&#x2F;etc&#x2F;neutron&#x2F;plugin.ini的符号链接</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</span><br></pre></td></tr></table></figure>
</li>
<li><p>同步数据库</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head&quot; neutron</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启nova api服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-nova-api</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动网络服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable neutron-server.service neutron-linuxbridge-agent.service \</span><br><span class="line">neutron-dhcp-agent.service neutron-metadata-agent.service neutron-l3-agent.service</span><br><span class="line">systemctl start neutron-server.service neutron-linuxbridge-agent.service \</span><br><span class="line">neutron-dhcp-agent.service neutron-metadata-agent.service neutron-l3-agent.service</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>Compute节点</strong></p>
<ol>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-neutron-linuxbridge ebtables ipset -y</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Neutron</p>
<ul>
<li>修改&#x2F;etc&#x2F;neutron&#x2F;neutron.conf</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller</span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">memcached_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = neutron</span><br><span class="line"><span class="attr">password</span> = NEUTRON_PASS</span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_concurrency]</span></span><br><span class="line"><span class="attr">lock_path</span> = /var/lib/neutron/tmp</span><br></pre></td></tr></table></figure>

<ul>
<li>修改&#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[linux_bridge]</span></span><br><span class="line"><span class="attr">physical_interface_mappings</span> = provider:PROVIDER_INTERFACE_NAME</span><br><span class="line"></span><br><span class="line"><span class="section">[vxlan]</span></span><br><span class="line"><span class="attr">enable_vxlan</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">local_ip</span> = OVERLAY_INTERFACE_IP_ADDRESS</span><br><span class="line"><span class="attr">l2_population</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[securitygroup]</span></span><br><span class="line"><span class="attr">enable_security_group</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">firewall_driver</span> = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</span><br></pre></td></tr></table></figure>

<ul>
<li>配置nova compute服务使用neutron，修改&#x2F;etc&#x2F;nova&#x2F;nova.conf</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[neutron]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = default</span><br><span class="line"><span class="attr">user_domain_name</span> = default</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = neutron</span><br><span class="line"><span class="attr">password</span> = NEUTRON_PASS</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启nova-compute服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-nova-compute.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Neutron linuxbridge agent服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable neutron-linuxbridge-agent</span><br><span class="line">systemctl start neutron-linuxbridge-agent</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Cinder"><a href="#Cinder" class="headerlink" title="Cinder"></a>Cinder</h4><p>Cinder是OpenStack的存储服务，提供块设备的创建、发放、备份等功能。</p>
<p><strong>Controller节点</strong>：</p>
<ol>
<li><p>初始化数据库</p>
<p> <code>CINDER_DBPASS</code>是用户自定义的cinder数据库密码。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE cinder;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> cinder.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;cinder&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;CINDER_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> cinder.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;cinder&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;CINDER_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> exit</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化Keystone资源对象</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建用户时，命令行会提示输入密码，请输入自定义的密码，下文涉及到`CINDER_PASS`的地方替换成该密码即可。</span></span><br><span class="line">openstack user create --domain default --password-prompt cinder</span><br><span class="line"></span><br><span class="line">openstack role add --project service --user cinder admin</span><br><span class="line">openstack service create --name cinderv3 --description &quot;OpenStack Block Storage&quot; volumev3</span><br><span class="line"></span><br><span class="line">openstack endpoint create --region RegionOne volumev3 public http://controller:8776/v3/%\(project_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne volumev3 internal http://controller:8776/v3/%\(project_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne volumev3 admin http://controller:8776/v3/%\(project_id\)s</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-cinder-api openstack-cinder-scheduler</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改cinder配置文件<code>/etc/cinder/cinder.conf</code></p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller</span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"><span class="attr">my_ip</span> = <span class="number">192.168</span>.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">memcached_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = cinder</span><br><span class="line"><span class="attr">password</span> = CINDER_PASS</span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_concurrency]</span></span><br><span class="line"><span class="attr">lock_path</span> = /var/lib/cinder/tmp</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据库同步</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;cinder-manage db sync&quot; cinder</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改nova配置<code>/etc/nova/nova.conf</code></p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[cinder]</span></span><br><span class="line"><span class="attr">os_region_name</span> = RegionOne</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart openstack-nova-api</span><br><span class="line">systemctl start openstack-cinder-api openstack-cinder-scheduler</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>Storage节点</strong>：</p>
<p>Storage节点要提前准备至少一块硬盘，作为cinder的存储后端，下文默认storage节点已经存在一块未使用的硬盘，设备名称为<code>/dev/sdb</code>，用户在配置过程中，请按照真实环境信息进行名称替换。</p>
<p>Cinder支持很多类型的后端存储，本指导使用最简单的lvm为参考，如果您想使用如ceph等其他后端，请自行配置。</p>
<ol>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install lvm2 device-mapper-persistent-data scsi-target-utils rpcbind nfs-utils openstack-cinder-volume openstack-cinder-backup</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置lvm卷组</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pvcreate /dev/sdb</span><br><span class="line">vgcreate cinder-volumes /dev/sdb</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改cinder配置<code>/etc/cinder/cinder.conf</code></p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller</span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"><span class="attr">my_ip</span> = <span class="number">192.168</span>.<span class="number">0.4</span></span><br><span class="line"><span class="attr">enabled_backends</span> = lvm</span><br><span class="line"><span class="attr">glance_api_servers</span> = http://controller:<span class="number">9292</span></span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">memcached_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = default</span><br><span class="line"><span class="attr">user_domain_name</span> = default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = cinder</span><br><span class="line"><span class="attr">password</span> = CINDER_PASS</span><br><span class="line"></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder</span><br><span class="line"></span><br><span class="line"><span class="section">[lvm]</span></span><br><span class="line"><span class="attr">volume_driver</span> = cinder.volume.drivers.lvm.LVMVolumeDriver</span><br><span class="line"><span class="attr">volume_group</span> = cinder-volumes</span><br><span class="line"><span class="attr">target_protocol</span> = iscsi</span><br><span class="line"><span class="attr">target_helper</span> = lioadm</span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_concurrency]</span></span><br><span class="line"><span class="attr">lock_path</span> = /var/lib/cinder/tmp</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置cinder backup （可选）</p>
<p> cinder-backup是可选的备份服务，cinder同样支持很多种备份后端，本文使用swift存储，如果您想使用如NFS等后端，请自行配置，例如可以参考<a target="_blank" rel="noopener" href="https://docs.openstack.org/cinder/2023.1/admin/nfs-backend.html">OpenStack官方文档</a>对NFS的配置说明。</p>
<p> 修改<code>/etc/cinder/cinder.conf</code>，在<code>[DEFAULT]</code>中新增</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">backup_driver</span> = cinder.backup.drivers.swift.SwiftBackupDriver</span><br><span class="line"><span class="attr">backup_swift_url</span> = SWIFT_URL</span><br></pre></td></tr></table></figure>

<p> 这里的<code>SWIFT_URL</code>是指环境中swift服务的URL，在部署完swift服务后，执行<code>openstack catalog show object-store</code>命令获取。</p>
</li>
<li><p>启动服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start openstack-cinder-volume target</span><br><span class="line">systemctl start openstack-cinder-backup (可选)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>至此，Cinder服务的部署已全部完成，可以在controller通过以下命令进行简单的验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br><span class="line">openstack storage service list</span><br><span class="line">openstack volume list</span><br></pre></td></tr></table></figure>

<h4 id="Horizon"><a href="#Horizon" class="headerlink" title="Horizon"></a>Horizon</h4><p>Horizon是OpenStack提供的前端页面，可以让用户通过网页鼠标的操作来控制OpenStack集群，而不用繁琐的CLI命令行。Horizon一般部署在控制节点。</p>
<ol>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-dashboard</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件<code>/etc/openstack-dashboard/local_settings</code></p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">OPENSTACK_HOST</span> = <span class="string">&quot;controller&quot;</span></span><br><span class="line"><span class="attr">ALLOWED_HOSTS</span> = [<span class="string">&#x27;*&#x27;</span>, ]</span><br><span class="line"><span class="attr">OPENSTACK_KEYSTONE_URL</span> =  <span class="string">&quot;http://controller:5000/v3&quot;</span></span><br><span class="line"><span class="attr">SESSION_ENGINE</span> = <span class="string">&#x27;django.contrib.sessions.backends.cache&#x27;</span></span><br><span class="line"><span class="attr">CACHES</span> = &#123;</span><br><span class="line">&#x27;default&#x27;: &#123;</span><br><span class="line">    &#x27;BACKEND&#x27;: &#x27;django.core.cache.backends.memcached.MemcachedCache&#x27;,</span><br><span class="line">    &#x27;LOCATION&#x27;: &#x27;controller:11211&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attr">OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">OPENSTACK_KEYSTONE_DEFAULT_DOMAIN</span> = <span class="string">&quot;Default&quot;</span></span><br><span class="line"><span class="attr">OPENSTACK_KEYSTONE_DEFAULT_ROLE</span> = <span class="string">&quot;member&quot;</span></span><br><span class="line"><span class="attr">WEBROOT</span> = <span class="string">&#x27;/dashboard&#x27;</span></span><br><span class="line"><span class="attr">POLICY_FILES_PATH</span> = <span class="string">&quot;/etc/openstack-dashboard&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">OPENSTACK_API_VERSIONS</span> = &#123;</span><br><span class="line">    &quot;identity&quot;: 3,</span><br><span class="line">    &quot;image&quot;: 2,</span><br><span class="line">    &quot;volume&quot;: 3,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd</span><br></pre></td></tr></table></figure></li>
</ol>
<p>至此，horizon服务的部署已全部完成，打开浏览器，输入<code>http://192.168.0.2/dashboard</code>，打开horizon登录页面。</p>
<h4 id="Ironic"><a href="#Ironic" class="headerlink" title="Ironic"></a>Ironic</h4><p>Ironic是OpenStack的裸金属服务，如果用户需要进行裸机部署则推荐使用该组件。否则，可以不用安装。</p>
<p>在控制节点执行以下操作。</p>
<ol>
<li><p>设置数据库</p>
<p> 裸金属服务在数据库中存储信息，创建一个<strong>ironic</strong>用户可以访问的<strong>ironic</strong>数据库，替换<strong>IRONIC_DBPASS</strong>为合适的密码</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE ironic <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> ironic.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;ironic&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> \</span><br><span class="line">IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;IRONIC_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> ironic.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;ironic&#x27;</span>@<span class="string">&#x27;%&#x27;</span> \</span><br><span class="line">IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;IRONIC_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建服务用户认证</p>
<ul>
<li>创建Bare Metal服务用户</li>
</ul>
<p> 替换<code>IRONIC_PASS</code>为ironic用户密码，<code>IRONIC_INSPECTOR_PASS</code>为ironic_inspector用户密码。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --password IRONIC_PASS \</span><br><span class="line">    --email ironic@example.com ironic</span><br><span class="line">openstack role add --project service --user ironic admin</span><br><span class="line">openstack service create --name ironic \</span><br><span class="line">    --description &quot;Ironic baremetal provisioning service&quot; baremetal</span><br><span class="line"></span><br><span class="line">openstack service create --name ironic-inspector --description     &quot;Ironic inspector baremetal provisioning service&quot; baremetal-introspection</span><br><span class="line">openstack user create --password IRONIC_INSPECTOR_PASS --email ironic_inspector@example.com ironic-inspector</span><br><span class="line">openstack role add --project service --user ironic-inspector admin</span><br></pre></td></tr></table></figure>

<ul>
<li>创建Bare Metal服务访问入口</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne baremetal admin http://192.168.0.2:6385</span><br><span class="line">openstack endpoint create --region RegionOne baremetal public http://192.168.0.2:6385</span><br><span class="line">openstack endpoint create --region RegionOne baremetal internal http://192.168.0.2:6385</span><br><span class="line">openstack endpoint create --region RegionOne baremetal-introspection internal http://192.168.0.2:5050/v1</span><br><span class="line">openstack endpoint create --region RegionOne baremetal-introspection public http://192.168.0.2:5050/v1</span><br><span class="line">openstack endpoint create --region RegionOne baremetal-introspection admin http://192.168.0.2:5050/v1</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装组件</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-ironic-api openstack-ironic-conductor python3-ironicclient</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置ironic-api服务</p>
<p> 配置文件路径&#x2F;etc&#x2F;ironic&#x2F;ironic.conf</p>
<ul>
<li>通过<strong>connection</strong>选项配置数据库的位置，如下所示，替换<strong>IRONIC_DBPASS</strong>为<strong>ironic</strong>用户的密码，替换<strong>DB_IP</strong>为DB服务器所在的IP地址：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[database]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The SQ LAlchemy connection string used to connect to the</span></span><br><span class="line"><span class="comment"># database (string value)</span></span><br><span class="line"><span class="comment"># connection = mysql+pymysql://ironic:IRONIC_DBPASS@DB_IP/ironic</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://ironic:IRONIC_DBPASS@controller/ironic</span><br></pre></td></tr></table></figure>

<ul>
<li>通过以下选项配置ironic-api服务使用RabbitMQ消息代理，替换**RPC_***为RabbitMQ的详细地址和凭证</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A URL representing the messaging driver to use and its full</span></span><br><span class="line"><span class="comment"># configuration. (string value)</span></span><br><span class="line"><span class="comment"># transport_url = rabbit://RPC_USER:RPC_PASSWORD@RPC_HOST:RPC_PORT/</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br></pre></td></tr></table></figure>

<p> 用户也可自行使用json-rpc方式替换rabbitmq</p>
<ul>
<li>配置ironic-api服务使用身份认证服务的凭证，替换<strong>PUBLIC_IDENTITY_IP</strong>为身份认证服务器的公共IP，替换<strong>PRIVATE_IDENTITY_IP</strong>为身份认证服务器的私有IP，替换     <strong>IRONIC_PASS</strong>为身份认证服务中<strong>ironic</strong>用户的密码，替换<strong>RABBIT_PASS</strong>为RabbitMQ中openstack账户的密码。：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Authentication strategy used by ironic-api: one of</span></span><br><span class="line"><span class="comment"># &quot;keystone&quot; or &quot;noauth&quot;. &quot;noauth&quot; should not be used in a</span></span><br><span class="line"><span class="comment"># production environment because all authentication will be</span></span><br><span class="line"><span class="comment"># disabled. (string value)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">auth_strategy</span>=keystone</span><br><span class="line"><span class="attr">host</span> = controller</span><br><span class="line"><span class="attr">memcache_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">enabled_network_interfaces</span> = flat,noop,neutron</span><br><span class="line"><span class="attr">default_network_interface</span> = noop</span><br><span class="line"><span class="attr">enabled_hardware_types</span> = ipmi</span><br><span class="line"><span class="attr">enabled_boot_interfaces</span> = pxe</span><br><span class="line"><span class="attr">enabled_deploy_interfaces</span> = direct</span><br><span class="line"><span class="attr">default_deploy_interface</span> = direct</span><br><span class="line"><span class="attr">enabled_inspect_interfaces</span> = inspector</span><br><span class="line"><span class="attr">enabled_management_interfaces</span> = ipmitool</span><br><span class="line"><span class="attr">enabled_power_interfaces</span> = ipmitool</span><br><span class="line"><span class="attr">enabled_rescue_interfaces</span> = <span class="literal">no</span>-rescue,agent</span><br><span class="line"><span class="attr">isolinux_bin</span> = /usr/share/syslinux/isolinux.bin</span><br><span class="line"><span class="attr">logging_context_format_string</span> = %(asctime)s.%(msecs)<span class="number">03</span>d %(process)d %(levelname)s %(name)s [%(global_request_id)s %(request_id)s %     (user_identity)s] %(instance)s%(message)s</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="comment"># Authentication type to load (string value)</span></span><br><span class="line"><span class="attr">auth_type</span>=password</span><br><span class="line"><span class="comment"># Complete public Identity API endpoint (string value)</span></span><br><span class="line"><span class="comment"># www_authenticate_uri=http://PUBLIC_IDENTITY_IP:5000</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span>=http://controller:<span class="number">5000</span></span><br><span class="line"><span class="comment"># Complete admin Identity API endpoint. (string value)</span></span><br><span class="line"><span class="comment"># auth_url=http://PRIVATE_IDENTITY_IP:5000</span></span><br><span class="line"><span class="attr">auth_url</span>=http://controller:<span class="number">5000</span></span><br><span class="line"><span class="comment"># Service username. (string value)</span></span><br><span class="line"><span class="attr">username</span>=ironic</span><br><span class="line"><span class="comment"># Service account password. (string value)</span></span><br><span class="line"><span class="attr">password</span>=IRONIC_PASS</span><br><span class="line"><span class="comment"># Service tenant name. (string value)</span></span><br><span class="line"><span class="attr">project_name</span>=service</span><br><span class="line"><span class="comment"># Domain name containing project (string value)</span></span><br><span class="line"><span class="attr">project_domain_name</span>=Default</span><br><span class="line"><span class="comment"># User&#x27;s domain name (string value)</span></span><br><span class="line"><span class="attr">user_domain_name</span>=Default</span><br><span class="line"></span><br><span class="line"><span class="section">[agent]</span></span><br><span class="line"><span class="attr">deploy_logs_collect</span> = always</span><br><span class="line"><span class="attr">deploy_logs_local_path</span> = /var/log/ironic/deploy</span><br><span class="line"><span class="attr">deploy_logs_storage_backend</span> = local</span><br><span class="line"><span class="attr">image_download_source</span> = http</span><br><span class="line"><span class="attr">stream_raw_images</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">force_raw_images</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">verify_ca</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_concurrency]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_messaging_notifications]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br><span class="line"><span class="attr">topics</span> = notifications</span><br><span class="line"><span class="attr">driver</span> = messagingv2</span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_messaging_rabbit]</span></span><br><span class="line"><span class="attr">amqp_durable_queues</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">rabbit_ha_queues</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="section">[pxe]</span></span><br><span class="line"><span class="attr">ipxe_enabled</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">pxe_append_params</span> = nofb nomodeset vga=normal coreos.autologin ipa-insecure=<span class="number">1</span></span><br><span class="line"><span class="attr">image_cache_size</span> = <span class="number">204800</span></span><br><span class="line"><span class="attr">tftp_root</span>=/var/lib/tftpboot/cephfs/</span><br><span class="line"><span class="attr">tftp_master_path</span>=/var/lib/tftpboot/cephfs/master_images</span><br><span class="line"></span><br><span class="line"><span class="section">[dhcp]</span></span><br><span class="line"><span class="attr">dhcp_provider</span> = none</span><br></pre></td></tr></table></figure>

<ul>
<li>创建裸金属服务数据库表</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ironic-dbsync --config-file /etc/ironic/ironic.conf create_schema</span><br></pre></td></tr></table></figure>

<ul>
<li>重启ironic-api服务</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart openstack-ironic-api</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置ironic-conductor服务</p>
<p> 如下为ironic-conductor服务自身的标准配置，ironic-conductor服务可以与ironic-api服务分布于不同节点，本指南中均部署与控制节点，所以重复的配置项可跳过。</p>
<ul>
<li>替换使用conductor服务所在host的IP配置my_ip：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># IP address of this host. If unset, will determine the IP</span></span><br><span class="line"><span class="comment"># programmatically. If unable to do so, will use &quot;127.0.0.1&quot;.</span></span><br><span class="line"><span class="comment"># (string value)</span></span><br><span class="line"><span class="comment"># my_ip=HOST_IP</span></span><br><span class="line"><span class="attr">my_ip</span> = <span class="number">192.168</span>.<span class="number">0.2</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置数据库的位置，ironic-conductor应该使用和ironic-api相同的配置。替换<strong>IRONIC_DBPASS</strong>为<strong>ironic</strong>用户的密码：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[database]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The SQLAlchemy connection string to use to connect to the</span></span><br><span class="line"><span class="comment"># database. (string value)</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://ironic:IRONIC_DBPASS@controller/ironic</span><br></pre></td></tr></table></figure>

<ul>
<li>通过以下选项配置ironic-api服务使用RabbitMQ消息代理，ironic-conductor应该使用和ironic-api相同的配置，替换<strong>RABBIT_PASS</strong>为RabbitMQ中openstack账户的密码：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A URL representing the messaging driver to use and its full</span></span><br><span class="line"><span class="comment"># configuration. (string value)</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br></pre></td></tr></table></figure>

<p> 用户也可自行使用json-rpc方式替换rabbitmq</p>
<ul>
<li>配置凭证访问其他OpenStack服务</li>
</ul>
<p> 为了与其他OpenStack服务进行通信，裸金属服务在请求其他服务时需要使用服务用户与OpenStack Identity服务进行认证。这些用户的凭据必须在与相应服务相关的每个配置文件中进行配置。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[neutron] - 访问OpenStack网络服务</span><br><span class="line">[glance] - 访问OpenStack镜像服务</span><br><span class="line">[swift] - 访问OpenStack对象存储服务</span><br><span class="line">[cinder] - 访问OpenStack块存储服务</span><br><span class="line">[inspector] - 访问OpenStack裸金属introspection服务</span><br><span class="line">[service_catalog] - 一个特殊项用于保存裸金属服务使用的凭证，该凭证用于发现注册在OpenStack身份认证服务目录中的自己的API URL端点</span><br></pre></td></tr></table></figure>

<p> 简单起见，可以对所有服务使用同一个服务用户。为了向后兼容，该用户应该和ironic-api服务的[keystone_authtoken]所配置的为同一个用户。但这不是必须的，也可以为每个服务创建并配置不同的服务用户。</p>
<p> 在下面的示例中，用户访问OpenStack网络服务的身份验证信息配置为：</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">网络服务部署在名为RegionOne的身份认证服务域中，仅在服务目录中注册公共端点接口</span><br><span class="line"></span><br><span class="line">请求时使用特定的CA SSL证书进行HTTPS连接</span><br><span class="line"></span><br><span class="line">与ironic-api服务配置相同的服务用户</span><br><span class="line"></span><br><span class="line">动态密码认证插件基于其他选项发现合适的身份认证服务API版本</span><br></pre></td></tr></table></figure>

<p> 替换IRONIC_PASS为ironic用户密码。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[neutron]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Authentication type to load (string value)</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="comment"># Authentication URL (string value)</span></span><br><span class="line"><span class="attr">auth_url</span>=https://IDENTITY_IP:<span class="number">5000</span>/</span><br><span class="line"><span class="comment"># Username (string value)</span></span><br><span class="line"><span class="attr">username</span>=ironic</span><br><span class="line"><span class="comment"># User&#x27;s password (string value)</span></span><br><span class="line"><span class="attr">password</span>=IRONIC_PASS</span><br><span class="line"><span class="comment"># Project name to scope to (string value)</span></span><br><span class="line"><span class="attr">project_name</span>=service</span><br><span class="line"><span class="comment"># Domain ID containing project (string value)</span></span><br><span class="line"><span class="attr">project_domain_id</span>=default</span><br><span class="line"><span class="comment"># User&#x27;s domain id (string value)</span></span><br><span class="line"><span class="attr">user_domain_id</span>=default</span><br><span class="line"><span class="comment"># PEM encoded Certificate Authority to use when verifying</span></span><br><span class="line"><span class="comment"># HTTPs connections. (string value)</span></span><br><span class="line"><span class="attr">cafile</span>=/opt/stack/data/ca-bundle.pem</span><br><span class="line"><span class="comment"># The default region_name for endpoint URL discovery. (string</span></span><br><span class="line"><span class="comment"># value)</span></span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="comment"># List of interfaces, in order of preference, for endpoint</span></span><br><span class="line"><span class="comment"># URL. (list value)</span></span><br><span class="line"><span class="attr">valid_interfaces</span>=public</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他参考配置</span></span><br><span class="line"><span class="section">[glance]</span></span><br><span class="line"><span class="attr">endpoint_override</span> = http://controller:<span class="number">9292</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">username</span> = ironic</span><br><span class="line"><span class="attr">password</span> = IRONIC_PASS</span><br><span class="line"><span class="attr">project_domain_name</span> = default</span><br><span class="line"><span class="attr">user_domain_name</span> = default</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"></span><br><span class="line"><span class="section">[service_catalog]</span>  </span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_domain_id</span> = default</span><br><span class="line"><span class="attr">user_domain_id</span> = default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">password</span> = IRONIC_PASS</span><br><span class="line"><span class="attr">username</span> = ironic</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br></pre></td></tr></table></figure>

<p> 默认情况下，为了与其他服务进行通信，裸金属服务会尝试通过身份认证服务的服务目录发现该服务合适的端点。如果希望对一个特定服务使用一个不同的端点，则在裸金属服务的配置文件中通过endpoint_override选项进行指定：</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[neutron]</span></span><br><span class="line"><span class="attr">endpoint_override</span> = &lt;NEUTRON_API_ADDRESS&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置允许的驱动程序和硬件类型</li>
</ul>
<p> 通过设置enabled_hardware_types设置ironic-conductor服务允许使用的硬件类型：</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">enabled_hardware_types</span> = ipmi</span><br></pre></td></tr></table></figure>

<p> 配置硬件接口：</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">enabled_boot_interfaces</span> = pxe</span><br><span class="line"><span class="attr">enabled_deploy_interfaces</span> = direct,iscsi</span><br><span class="line"><span class="attr">enabled_inspect_interfaces</span> = inspector</span><br><span class="line"><span class="attr">enabled_management_interfaces</span> = ipmitool</span><br><span class="line"><span class="attr">enabled_power_interfaces</span> = ipmitool</span><br></pre></td></tr></table></figure>

<p> 配置接口默认值：</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">default_deploy_interface</span> = direct</span><br><span class="line"><span class="attr">default_network_interface</span> = neutron</span><br></pre></td></tr></table></figure>

<p> 如果启用了任何使用Direct deploy的驱动，必须安装和配置镜像服务的Swift后端。Ceph对象网关(RADOS网关)也支持作为镜像服务的后端。</p>
<ul>
<li>重启ironic-conductor服务</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart openstack-ironic-conductor</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置ironic-inspector服务</p>
<ul>
<li>安装组件</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-ironic-inspector</span><br></pre></td></tr></table></figure>

<ul>
<li>创建数据库</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE ironic_inspector <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> ironic_inspector.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;ironic_inspector&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> \</span><br><span class="line">IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;IRONIC_INSPECTOR_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> ironic_inspector.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;ironic_inspector&#x27;</span>@<span class="string">&#x27;%&#x27;</span> \</span><br><span class="line">IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;IRONIC_INSPECTOR_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> exit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<ul>
<li>配置<code>/etc/ironic-inspector/inspector.conf</code></li>
</ul>
<p> 通过<strong>connection</strong>选项配置数据库的位置，如下所示，替换<strong>IRONIC_INSPECTOR_DBPASS</strong>为<strong>ironic_inspector</strong>用户的密码</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">backend</span> = sqlalchemy</span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://ironic_inspector:IRONIC_INSPECTOR_DBPASS@controller/ironic_inspector</span><br><span class="line"><span class="attr">min_pool_size</span> = <span class="number">100</span></span><br><span class="line"><span class="attr">max_pool_size</span> = <span class="number">500</span></span><br><span class="line"><span class="attr">pool_timeout</span> = <span class="number">30</span></span><br><span class="line"><span class="attr">max_retries</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">max_overflow</span> = <span class="number">200</span></span><br><span class="line"><span class="attr">db_retry_interval</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">db_inc_retry_interval</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">db_max_retry_interval</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">db_max_retries</span> = <span class="number">5</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置消息队列通信地址</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span> </span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br></pre></td></tr></table></figure>

<ul>
<li>设置keystone认证</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"><span class="attr">timeout</span> = <span class="number">900</span></span><br><span class="line"><span class="attr">rootwrap_config</span> = /etc/ironic-inspector/rootwrap.conf</span><br><span class="line"><span class="attr">logging_context_format_string</span> = %(asctime)s.%(msecs)<span class="number">03</span>d %(process)d %(levelname)s %(name)s [%(global_request_id)s %(request_id)s %     (user_identity)s] %(instance)s%(message)s</span><br><span class="line"><span class="attr">log_dir</span> = /var/log/ironic-inspector</span><br><span class="line"><span class="attr">state_path</span> = /var/lib/ironic-inspector</span><br><span class="line"><span class="attr">use_stderr</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ironic]</span></span><br><span class="line"><span class="attr">api_endpoint</span> = http://IRONIC_API_HOST_ADDRRESS:<span class="number">6385</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">auth_url</span> = http://PUBLIC_IDENTITY_IP:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"><span class="attr">ironic_url</span> = http://IRONIC_API_HOST_ADDRRESS:<span class="number">6385</span></span><br><span class="line"><span class="attr">os_region</span> = RegionOne</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">username</span> = IRONIC_SERVICE_USER_NAME</span><br><span class="line"><span class="attr">password</span> = IRONIC_SERVICE_USER_PASSWORD</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">project_domain_name</span> = default</span><br><span class="line"><span class="attr">user_domain_name</span> = default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = ironic_inspector</span><br><span class="line"><span class="attr">password</span> = IRONICPASSWD</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">memcache_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">token_cache_time</span> = <span class="number">300</span></span><br><span class="line"></span><br><span class="line"><span class="section">[processing]</span></span><br><span class="line"><span class="attr">add_ports</span> = active</span><br><span class="line"><span class="attr">processing_hooks</span> = <span class="variable">$default_processing_hooks</span>,local_link_connection,lldp_basic</span><br><span class="line"><span class="attr">ramdisk_logs_dir</span> = /var/log/ironic-inspector/ramdisk</span><br><span class="line"><span class="attr">always_store_ramdisk_logs</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">store_data</span> =none</span><br><span class="line"><span class="attr">power_off</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="section">[pxe_filter]</span></span><br><span class="line"><span class="attr">driver</span> = iptables</span><br><span class="line"></span><br><span class="line"><span class="section">[capabilities]</span></span><br><span class="line"><span class="attr">boot_mode</span>=<span class="literal">True</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置ironic inspector dnsmasq服务</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置文件地址：/etc/ironic-inspector/dnsmasq.conf</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">interface</span>=enp3s0                         <span class="comment">#替换为实际监听网络接口</span></span><br><span class="line"><span class="attr">dhcp-range</span>=<span class="number">192.168</span>.<span class="number">0.40</span>,<span class="number">192.168</span>.<span class="number">0.50</span>   <span class="comment">#替换为实际dhcp地址范围</span></span><br><span class="line">bind-interfaces</span><br><span class="line">enable-tftp</span><br><span class="line"></span><br><span class="line"><span class="attr">dhcp-match</span>=set:efi,option:client-arch,<span class="number">7</span></span><br><span class="line"><span class="attr">dhcp-match</span>=set:efi,option:client-arch,<span class="number">9</span></span><br><span class="line"><span class="attr">dhcp-match</span>=aarch64, option:client-arch,<span class="number">11</span></span><br><span class="line"><span class="attr">dhcp-boot</span>=tag:aarch64,grubaa64.efi</span><br><span class="line"><span class="attr">dhcp-boot</span>=tag:!aarch64,tag:efi,grubx64.efi</span><br><span class="line"><span class="attr">dhcp-boot</span>=tag:!aarch64,tag:!efi,pxelinux.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tftp-root</span>=/tftpboot                       <span class="comment">#替换为实际tftpboot目录</span></span><br><span class="line"><span class="attr">log-facility</span>=/var/log/dnsmasq.log</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭ironic provision网络子网的dhcp</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack subnet set --no-dhcp 72426e89-f552-4dc4-9ac7-c4e131ce7f3c</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化ironic-inspector服务的数据库</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ironic-inspector-dbsync --config-file /etc/ironic-inspector/inspector.conf upgrade</span><br></pre></td></tr></table></figure>

<ul>
<li>启动服务</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable --now openstack-ironic-inspector.service</span><br><span class="line">systemctl enable --now openstack-ironic-inspector-dnsmasq.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置httpd服务</p>
<ul>
<li>创建ironic要使用的httpd的root目录并设置属主属组，目录路径要和&#x2F;etc&#x2F;ironic&#x2F;ironic.conf中[deploy]组中http_root 配置项指定的路径要一致。</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/ironic/httproot</span><br><span class="line">chown ironic.ironic /var/lib/ironic/httproot</span><br></pre></td></tr></table></figure>

<ul>
<li><p>安装和配置httpd服务</p>
<ul>
<li>安装httpd服务，已有请忽略</li>
</ul>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install httpd -y</span><br></pre></td></tr></table></figure>

<ul>
<li>创建&#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;openstack-ironic-httpd.conf文件，内容如下：</li>
</ul>
  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Listen 8080</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerName ironic.openeuler.com</span><br><span class="line"></span><br><span class="line">    ErrorLog &quot;/var/log/httpd/openstack-ironic-httpd-error_log&quot;</span><br><span class="line">    CustomLog &quot;/var/log/httpd/openstack-ironic-httpd-access_log&quot; &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b&quot;</span><br><span class="line"></span><br><span class="line">    DocumentRoot &quot;/var/lib/ironic/httproot&quot;</span><br><span class="line">    &lt;Directory &quot;/var/lib/ironic/httproot&quot;&gt;</span><br><span class="line">        Options Indexes FollowSymLinks</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">    LogLevel warn</span><br><span class="line">    AddDefaultCharset UTF-8</span><br><span class="line">    EnableSendfile on</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<p>  注意监听的端口要和&#x2F;etc&#x2F;ironic&#x2F;ironic.conf里[deploy]选项中http_url配置项中指定的端口一致。</p>
<ul>
<li>重启httpd服务。</li>
</ul>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>deploy ramdisk镜像下载或制作</p>
<p> 部署一个裸机节点总共需要两组镜像：deploy ramdisk images和user images。Deploy ramdisk images上运行有ironic-python-agent(IPA)服务，Ironic通过它进行裸机节点的环境准备。User images是最终被安装裸机节点上，供用户使用的镜像。</p>
<p> ramdisk镜像支持通过ironic-python-agent-builder或disk-image-builder工具制作。用户也可以自行选择其他工具制作。若使用原生工具，则需要安装对应的软件包。</p>
<p> 具体的使用方法可以参考<a target="_blank" rel="noopener" href="https://docs.openstack.org/ironic/2023.1/install/deploy-ramdisk.html">官方文档</a>，同时官方也有提供制作好的deploy镜像，可尝试下载。</p>
<p> 下文介绍通过ironic-python-agent-builder构建ironic使用的deploy镜像的完整过程。</p>
<ul>
<li>安装 ironic-python-agent-builder</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dnf install python3-ironic-python-agent-builder</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line">pip3 install ironic-python-agent-builder</span><br><span class="line">dnf install qemu-img git</span><br></pre></td></tr></table></figure>

<ul>
<li>制作镜像</li>
</ul>
<p> 基本用法：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">usage: ironic-python-agent-builder [-h] [-r RELEASE] [-o OUTPUT] [-e ELEMENT] [-b BRANCH]</span><br><span class="line">                            [-v] [--lzma] [--extra-args EXTRA_ARGS]</span><br><span class="line">                            [--elements-path ELEMENTS_PATH]</span><br><span class="line">                            distribution</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">    distribution          Distribution to use</span><br><span class="line"></span><br><span class="line">options:</span><br><span class="line">    -h, --help            show this help message and exit</span><br><span class="line">    -r RELEASE, --release RELEASE</span><br><span class="line">                        Distribution release to use</span><br><span class="line">    -o OUTPUT, --output OUTPUT</span><br><span class="line">                        Output base file name</span><br><span class="line">    -e ELEMENT, --element ELEMENT</span><br><span class="line">                        Additional DIB element to use</span><br><span class="line">    -b BRANCH, --branch BRANCH</span><br><span class="line">                        If set, override the branch that is used for         ironic-python-agent</span><br><span class="line">                        and requirements</span><br><span class="line">    -v, --verbose         Enable verbose logging in diskimage-builder</span><br><span class="line">    --lzma                Use lzma compression for smaller images</span><br><span class="line">    --extra-args EXTRA_ARGS</span><br><span class="line">                        Extra arguments to pass to diskimage-builder</span><br><span class="line">    --elements-path ELEMENTS_PATH</span><br><span class="line">                        Path(s) to custom DIB elements separated by a colon</span><br></pre></td></tr></table></figure>

<p> 操作实例：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-o选项指定生成的镜像名</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ubuntu指定生成ubuntu系统的镜像</span></span><br><span class="line">ironic-python-agent-builder -o my-ubuntu-ipa ubuntu</span><br></pre></td></tr></table></figure>

<p> 可通过设置<code>ARCH</code>环境变量（默认为amd64）指定所构建镜像的架构。如果是<code>arm</code>架构，需要添加：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ARCH=aarch64</span><br></pre></td></tr></table></figure>

<ul>
<li>允许ssh登录</li>
</ul>
<p> 初始化环境变量,设置用户名、密码，启用<code>sodo</code>权限；并添加<code>-e</code>选项使用相应的DIB元素。制作镜像操作如下：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export DIB_DEV_USER_USERNAME=ipa \</span><br><span class="line">export DIB_DEV_USER_PWDLESS_SUDO=yes \</span><br><span class="line">export DIB_DEV_USER_PASSWORD=&#x27;123&#x27;</span><br><span class="line">ironic-python-agent-builder -o my-ssh-ubuntu-ipa -e selinux-permissive -e devuser ubuntu</span><br></pre></td></tr></table></figure>

<ul>
<li>指定代码仓库</li>
</ul>
<p> 初始化对应的环境变量，然后制作镜像：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">直接从gerrit上<span class="built_in">clone</span>代码</span></span><br><span class="line">DIB_REPOLOCATION_ironic_python_agent=https://opendev.org/openstack/ironic-python-agent</span><br><span class="line">DIB_REPOREF_ironic_python_agent=stable/2023.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定本地仓库及分支</span></span><br><span class="line">DIB_REPOLOCATION_ironic_python_agent=/home/user/path/to/repo</span><br><span class="line">DIB_REPOREF_ironic_python_agent=my-test-branch</span><br><span class="line"></span><br><span class="line">ironic-python-agent-builder ubuntu</span><br></pre></td></tr></table></figure>

<p> 参考：<a target="_blank" rel="noopener" href="https://docs.openstack.org/diskimage-builder/latest/elements/source-repositories/README.html">source-repositories</a>。</p>
</li>
<li><p>注意</p>
<p> 原生的openstack里的pxe配置文件的模版不支持arm64架构，需要自己对原生openstack代码进行修改：<br> 在W版中，社区的ironic仍然不支持arm64位的uefi pxe启动，表现为生成的grub.cfg文件(一般位于&#x2F;tftpboot&#x2F;下)格式不对而导致pxe启动失败。</p>
<p> 生成的错误配置文件：</p>
<p> <img src="/../../img/install/ironic-err.png" alt="ironic-err"></p>
<p> 如上图所示，arm架构里寻找vmlinux和ramdisk镜像的命令分别是linux和initrd，上图所示的标红命令是x86架构下的uefi pxe启动。</p>
<p> 需要用户对生成grub.cfg的代码逻辑自行修改。</p>
<p> ironic向ipa发送查询命令执行状态请求的tls报错：</p>
<p> 当前版本的ipa和ironic默认都会开启tls认证的方式向对方发送请求，跟据官网的说明进行关闭即可。</p>
<ul>
<li>修改ironic配置文件(&#x2F;etc&#x2F;ironic&#x2F;ironic.conf)下面的配置中添加ipa-insecure&#x3D;1：</li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[agent]</span></span><br><span class="line"><span class="attr">verify_ca</span> = <span class="literal">False</span></span><br><span class="line"><span class="section">[pxe]</span></span><br><span class="line"><span class="attr">pxe_append_params</span> = nofb nomodeset vga=normal coreos.autologin ipa-insecure=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ramdisk镜像中添加ipa配置文件&#x2F;etc&#x2F;ironic_python_agent&#x2F;ironic_python_agent.conf并配置tls的配置如下：</li>
</ul>
<p> &#x2F;etc&#x2F;ironic_python_agent&#x2F;ironic_python_agent.conf (需要提前创建&#x2F;etc&#x2F;    ironic_python_agent目录）</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">enable_auto_tls</span> = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p> 设置权限：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R ipa.ipa /etc/ironic_python_agent/</span><br></pre></td></tr></table></figure>

<ul>
<li>ramdisk镜像中修改ipa服务的服务启动文件，添加配置文件选项</li>
</ul>
<p> 编辑&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;ironic-python-agent.service文件</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Ironic Python Agent</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">ExecStartPre</span>=/sbin/modprobe vfat</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/ironic-python-agent --config-file /etc/    ironic_python_agent/ironic_python_agent.conf</span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">30</span>s</span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Trove"><a href="#Trove" class="headerlink" title="Trove"></a>Trove</h4><p>Trove是OpenStack的数据库服务，如果用户使用OpenStack提供的数据库服务则推荐使用该组件。否则，可以不用安装。</p>
<p><strong>Controller节点</strong></p>
<ol>
<li><p>创建数据库。</p>
<p> 数据库服务在数据库中存储信息，创建一个trove用户可以访问的trove数据库，替换TROVE_DBPASS为合适的密码。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE trove <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> trove.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;trove&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;TROVE_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> trove.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;trove&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;TROVE_DBPASS&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建服务凭证以及API端点。</p>
<p> 创建服务凭证。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建trove用户</span></span><br><span class="line">openstack user create --domain default --password-prompt trove</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加admin角色</span></span><br><span class="line">openstack role add --project service --user trove admin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建database服务</span></span><br><span class="line">openstack service create --name trove --description &quot;Database service&quot; database</span><br></pre></td></tr></table></figure>

<p> 创建API端点。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne database public http://controller:8779/v1.0/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne database internal http://controller:8779/v1.0/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne database admin http://controller:8779/v1.0/%\(tenant_id\)s</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Trove。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-trove python-troveclient</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件。</p>
<p> 编辑&#x2F;etc&#x2F;trove&#x2F;trove.conf。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">bind_host</span>=<span class="number">192.168</span>.<span class="number">0.2</span></span><br><span class="line"><span class="attr">log_dir</span> = /var/log/trove</span><br><span class="line"><span class="attr">network_driver</span> = trove.network.neutron.NeutronDriver</span><br><span class="line"><span class="attr">network_label_regex</span>=.*</span><br><span class="line"><span class="attr">management_security_groups</span> = &lt;manage security group&gt;</span><br><span class="line"><span class="attr">nova_keypair</span> = trove-mgmt</span><br><span class="line"><span class="attr">default_datastore</span> = mysql</span><br><span class="line"><span class="attr">taskmanager_manager</span> = trove.taskmanager.manager.Manager</span><br><span class="line"><span class="attr">trove_api_workers</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br><span class="line"><span class="attr">reboot_time_out</span> = <span class="number">300</span></span><br><span class="line"><span class="attr">usage_timeout</span> = <span class="number">900</span></span><br><span class="line"><span class="attr">agent_call_high_timeout</span> = <span class="number">1200</span></span><br><span class="line"><span class="attr">use_syslog</span> = <span class="literal">False</span></span><br><span class="line"><span class="attr">debug</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://trove:TROVE_DBPASS@controller/trove</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3/</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">password</span> = trove</span><br><span class="line"><span class="attr">username</span> = TROVE_PASS</span><br><span class="line"></span><br><span class="line"><span class="section">[service_credentials]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3/</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">username</span> = trove</span><br><span class="line"><span class="attr">password</span> = TROVE_PASS</span><br><span class="line"></span><br><span class="line"><span class="section">[mariadb]</span></span><br><span class="line"><span class="attr">tcp_ports</span> = <span class="number">3306</span>,<span class="number">4444</span>,<span class="number">4567</span>,<span class="number">4568</span></span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">tcp_ports</span> = <span class="number">3306</span></span><br><span class="line"></span><br><span class="line"><span class="section">[postgresql]</span></span><br><span class="line"><span class="attr">tcp_ports</span> = <span class="number">5432</span></span><br></pre></td></tr></table></figure>

<p> <strong>解释：</strong></p>
<blockquote>
<p><code>[Default]</code>分组中<code>bind_host</code>配置为Trove控制节点的IP。<br><code>transport_url</code> 为<code>RabbitMQ</code>连接信息，<code>RABBIT_PASS</code>替换为RabbitMQ的密码。<br><code>[database]</code>分组中的<code>connection</code> 为前面在mysql中为Trove创建的数据库信息。<br>Trove的用户信息中<code>TROVE_PASSWORD</code>替换为实际trove用户的密码。</p>
</blockquote>
<p> 编辑&#x2F;etc&#x2F;trove&#x2F;trove-guestagent.conf。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">log_file</span> = trove-guestagent.log</span><br><span class="line"><span class="attr">log_dir</span> = /var/log/trove/</span><br><span class="line"><span class="attr">ignore_users</span> = os_admin</span><br><span class="line"><span class="attr">control_exchange</span> = trove</span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br><span class="line"><span class="attr">rpc_backend</span> = rabbit</span><br><span class="line"><span class="attr">command_process_timeout</span> = <span class="number">60</span></span><br><span class="line"><span class="attr">use_syslog</span> = <span class="literal">False</span></span><br><span class="line"><span class="attr">debug</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="section">[service_credentials]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3/</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">password</span> = TROVE_PASS</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">username</span> = trove</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">docker_image</span> = your-registry/your-repo/mysql</span><br><span class="line"><span class="attr">backup_docker_image</span> = your-registry/your-repo/db-backup-mysql:<span class="number">1.1</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p> <strong>解释：</strong> </p>
<blockquote>
<p><code>guestagent</code>是trove中一个独立组件，需要预先内置到Trove通过Nova创建的虚拟机镜像中，在创建好数据库实例后，会起guestagent进程，负责通过消息队列（RabbitMQ）向Trove上报心跳，因此需要配置RabbitMQ的用户和密码信息。<br><code>transport_url</code> 为<code>RabbitMQ</code>连接信息，<code>RABBIT_PASS</code>替换为RabbitMQ的密码。<br>Trove的用户信息中<code>TROVE_PASSWORD</code>替换为实际trove用户的密码。<br>从Victoria版开始，Trove使用一个统一的镜像来跑不同类型的数据库，数据库服务运行在Guest虚拟机的Docker容器中。</p>
</blockquote>
</li>
<li><p>数据库同步。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;trove-manage db_sync&quot; trove</span><br></pre></td></tr></table></figure>
</li>
<li><p>完成安装。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置服务自启</span></span><br><span class="line">systemctl enable openstack-trove-api.service openstack-trove-taskmanager.service \ </span><br><span class="line">openstack-trove-conductor.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务</span></span><br><span class="line">systemctl start openstack-trove-api.service openstack-trove-taskmanager.service \ </span><br><span class="line">openstack-trove-conductor.service</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Swift"><a href="#Swift" class="headerlink" title="Swift"></a>Swift</h4><p>Swift 提供了弹性可伸缩、高可用的分布式对象存储服务，适合存储大规模非结构化数据。</p>
<p><strong>Controller节点</strong></p>
<ol>
<li><p>创建服务凭证以及API端点。</p>
<p> 创建服务凭证。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建swift用户</span></span><br><span class="line">openstack user create --domain default --password-prompt swift</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加admin角色</span></span><br><span class="line">openstack role add --project service --user swift admin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建对象存储服务</span></span><br><span class="line">openstack service create --name swift --description &quot;OpenStack Object Storage&quot; object-store</span><br></pre></td></tr></table></figure>

<p> 创建API端点。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne object-store public http://controller:8080/v1/AUTH_%\(project_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne object-store internal http://controller:8080/v1/AUTH_%\(project_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne object-store admin http://controller:8080/v1 </span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Swift。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-swift-proxy python3-swiftclient python3-keystoneclient \ </span><br><span class="line">python3-keystonemiddleware memcached</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置proxy-server。</p>
<p> Swift RPM包里已经包含了一个基本可用的proxy-server.conf，只需要手动修改其中的ip和SWIFT_PASS即可。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/swift/proxy-server.conf</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:authtoken]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = keystonemiddleware.auth_token:filter_factory</span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">memcached_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_id</span> = default</span><br><span class="line"><span class="attr">user_domain_id</span> = default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = swift</span><br><span class="line"><span class="attr">password</span> = SWIFT_PASS</span><br><span class="line"><span class="attr">delay_auth_decision</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">service_token_roles_required</span> = <span class="literal">True</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>Storage节点</strong></p>
<ol>
<li><p>安装支持的程序包。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-swift-account openstack-swift-container openstack-swift-object</span><br><span class="line">dnf install xfsprogs rsync</span><br></pre></td></tr></table></figure>
</li>
<li><p>将设备&#x2F;dev&#x2F;sdb和&#x2F;dev&#x2F;sdc格式化为XFS。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs /dev/sdb</span><br><span class="line">mkfs.xfs /dev/sdc</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建挂载点目录结构。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /srv/node/sdb</span><br><span class="line">mkdir -p /srv/node/sdc</span><br></pre></td></tr></table></figure>
</li>
<li><p>找到新分区的UUID。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blkid</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑&#x2F;etc&#x2F;fstab文件并将以下内容添加到其中。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UUID=&quot;&lt;UUID-from-output-above&gt;&quot; /srv/node/sdb xfs noatime 0 2</span><br><span class="line">UUID=&quot;&lt;UUID-from-output-above&gt;&quot; /srv/node/sdc xfs noatime 0 2</span><br></pre></td></tr></table></figure>
</li>
<li><p>挂载设备。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount /srv/node/sdb</span><br><span class="line">mount /srv/node/sdc</span><br></pre></td></tr></table></figure>

<p> <em><strong>注意</strong></em></p>
<p> <strong>如果用户不需要容灾功能，以上步骤只需要创建一个设备即可，同时可以跳过下面的rsync配置。</strong></p>
</li>
<li><p>（可选）创建或编辑&#x2F;etc&#x2F;rsyncd.conf文件以包含以下内容:</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">uid</span> = swift</span><br><span class="line"><span class="attr">gid</span> = swift</span><br><span class="line">log <span class="attr">file</span> = /var/log/rsyncd.log</span><br><span class="line">pid <span class="attr">file</span> = /var/run/rsyncd.pid</span><br><span class="line"><span class="attr">address</span> = MANAGEMENT_INTERFACE_IP_ADDRESS</span><br><span class="line"></span><br><span class="line"><span class="section">[account]</span></span><br><span class="line">max <span class="attr">connections</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">path</span> = /srv/node/</span><br><span class="line">read <span class="attr">only</span> = <span class="literal">False</span></span><br><span class="line">lock <span class="attr">file</span> = /var/lock/account.lock</span><br><span class="line"></span><br><span class="line"><span class="section">[container]</span></span><br><span class="line">max <span class="attr">connections</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">path</span> = /srv/node/</span><br><span class="line">read <span class="attr">only</span> = <span class="literal">False</span></span><br><span class="line">lock <span class="attr">file</span> = /var/lock/container.lock</span><br><span class="line"></span><br><span class="line"><span class="section">[object]</span></span><br><span class="line">max <span class="attr">connections</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">path</span> = /srv/node/</span><br><span class="line">read <span class="attr">only</span> = <span class="literal">False</span></span><br><span class="line">lock <span class="attr">file</span> = /var/lock/object.lock</span><br></pre></td></tr></table></figure>

<p> <strong>替换MANAGEMENT_INTERFACE_IP_ADDRESS为存储节点上管理网络的IP地址</strong></p>
<p> 启动rsyncd服务并配置它在系统启动时启动:</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable rsyncd.service</span><br><span class="line">systemctl start rsyncd.service</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置存储节点。</p>
<p> 编辑&#x2F;etc&#x2F;swift目录的account-server.conf、container-server.conf和object-server.conf文件，替换bind_ip为存储节点上管理网络的IP地址。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">bind_ip</span> = <span class="number">192.168</span>.<span class="number">0.4</span></span><br></pre></td></tr></table></figure>

<p> 确保挂载点目录结构的正确所有权。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R swift:swift /srv/node</span><br></pre></td></tr></table></figure>

<p> 创建recon目录并确保其拥有正确的所有权。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/cache/swift</span><br><span class="line">chown -R root:swift /var/cache/swift</span><br><span class="line">chmod -R 775 /var/cache/swift</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>Controller节点创建并分发环</strong></p>
<ol>
<li><p>创建账号环。</p>
<p> 切换到<code>/etc/swift</code>目录。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/swift</span><br></pre></td></tr></table></figure>

<p> 创建基础<code>account.builder</code>文件。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder account.builder create 10 1 1</span><br></pre></td></tr></table></figure>

<p> 将每个存储节点添加到环中。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder account.builder add --region 1 --zone 1 \</span><br><span class="line">--ip STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESS \ </span><br><span class="line">--port 6202  --device DEVICE_NAME \ </span><br><span class="line">--weight 100</span><br></pre></td></tr></table></figure>

<blockquote>
<p>替换STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESS为存储节点上管理网络的IP地址。<br>替换DEVICE_NAME为同一存储节点上的存储设备名称。</p>
</blockquote>
<p> <em><strong>注意</strong></em></p>
<p> <strong>对每个存储节点上的每个存储设备重复此命令</strong></p>
<p> 验证账号环内容。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder account.builder</span><br></pre></td></tr></table></figure>

<p> 重新平衡账号环。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder account.builder rebalance</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建容器环。</p>
<p> 切换到<code>/etc/swift</code>目录。</p>
<p> 创建基础<code>container.builder</code>文件。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder container.builder create 10 1 1</span><br></pre></td></tr></table></figure>

<p> 将每个存储节点添加到环中。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder container.builder add --region 1 --zone 1 \</span><br><span class="line">--ip STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESS </span><br><span class="line">--port 6201 --device DEVICE_NAME \</span><br><span class="line">--weight 100</span><br></pre></td></tr></table></figure>

<blockquote>
<p>替换STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESS为存储节点上管理网络的IP地址。<br>替换DEVICE_NAME为同一存储节点上的存储设备名称。</p>
</blockquote>
<p> <em><strong>注意</strong></em></p>
<p> <strong>对每个存储节点上的每个存储设备重复此命令</strong></p>
<p> 验证容器环内容。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder container.builder</span><br></pre></td></tr></table></figure>

<p> 重新平衡容器环。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder container.builder rebalance</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建对象环。</p>
<p> 切换到<code>/etc/swift</code>目录。</p>
<p> 创建基础<code>object.builder</code>文件。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder object.builder create 10 1 1</span><br></pre></td></tr></table></figure>

<p> 将每个存储节点添加到环中。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder object.builder add --region 1 --zone 1 \</span><br><span class="line">--ip STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESS \</span><br><span class="line">--port 6200 --device DEVICE_NAME \</span><br><span class="line">--weight 100</span><br></pre></td></tr></table></figure>

<blockquote>
<p>替换STORAGE_NODE_MANAGEMENT_INTERFACE_IP_ADDRESS为存储节点上管理网络的IP地址。<br>替换DEVICE_NAME为同一存储节点上的存储设备名称。</p>
</blockquote>
<p> <em><strong>注意</strong></em></p>
<p> <strong>对每个存储节点上的每个存储设备重复此命令</strong></p>
<p> 验证对象环内容。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder object.builder</span><br></pre></td></tr></table></figure>

<p> 重新平衡对象环。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swift-ring-builder object.builder rebalance</span><br></pre></td></tr></table></figure>
</li>
<li><p>分发环配置文件。</p>
<p> 将<code>account.ring.gz</code>，<code>container.ring.gz</code>以及 <code>object.ring.gz</code>文件复制到每个存储节点和运行代理服务的任何其他节点上的<code>/etc/swift</code>目录。</p>
</li>
<li><p>编辑配置文件&#x2F;etc&#x2F;swift&#x2F;swift.conf。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[swift-hash]</span></span><br><span class="line"><span class="attr">swift_hash_path_suffix</span> = test-hash</span><br><span class="line"><span class="attr">swift_hash_path_prefix</span> = test-hash</span><br><span class="line"></span><br><span class="line"><span class="section">[storage-policy:0]</span></span><br><span class="line"><span class="attr">name</span> = Policy-<span class="number">0</span></span><br><span class="line"><span class="attr">default</span> = <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<p> <strong>用唯一值替换 test-hash</strong></p>
<p> 将swift.conf文件复制到&#x2F;etc&#x2F;swift每个存储节点和运行代理服务的任何其他节点上的目录。</p>
<p> 在所有节点上，确保配置目录的正确所有权。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R root:swift /etc/swift</span><br></pre></td></tr></table></figure>
</li>
<li><p>完成安装</p>
<p> 在控制节点和运行代理服务的任何其他节点上，启动对象存储代理服务及其依赖项，并将它们配置为在系统启动时启动。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openstack-swift-proxy.service memcached.service</span><br><span class="line">systemctl start openstack-swift-proxy.service memcached.service</span><br></pre></td></tr></table></figure>

<p> 在存储节点上，启动对象存储服务并将它们配置为在系统启动时启动。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openstack-swift-account.service \</span><br><span class="line">openstack-swift-account-auditor.service \</span><br><span class="line">openstack-swift-account-reaper.service \</span><br><span class="line">openstack-swift-account-replicator.service \</span><br><span class="line">openstack-swift-container.service \</span><br><span class="line">openstack-swift-container-auditor.service \</span><br><span class="line">openstack-swift-container-replicator.service \</span><br><span class="line">openstack-swift-container-updater.service \</span><br><span class="line">openstack-swift-object.service \</span><br><span class="line">openstack-swift-object-auditor.service \</span><br><span class="line">openstack-swift-object-replicator.service \</span><br><span class="line">openstack-swift-object-updater.service</span><br><span class="line"></span><br><span class="line">systemctl start openstack-swift-account.service \</span><br><span class="line">openstack-swift-account-auditor.service \</span><br><span class="line">openstack-swift-account-reaper.service \</span><br><span class="line">openstack-swift-account-replicator.service \</span><br><span class="line">openstack-swift-container.service \</span><br><span class="line">openstack-swift-container-auditor.service \</span><br><span class="line">openstack-swift-container-replicator.service \</span><br><span class="line">openstack-swift-container-updater.service \</span><br><span class="line">openstack-swift-object.service \</span><br><span class="line">openstack-swift-object-auditor.service \</span><br><span class="line">openstack-swift-object-replicator.service \</span><br><span class="line">openstack-swift-object-updater.service</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Cyborg"><a href="#Cyborg" class="headerlink" title="Cyborg"></a>Cyborg</h4><p>Cyborg为OpenStack提供加速器设备的支持，包括 GPU, FPGA, ASIC, NP, SoCs, NVMe&#x2F;NOF SSDs, ODP, DPDK&#x2F;SPDK等等。</p>
<p><strong>Controller节点</strong></p>
<ol>
<li><p>初始化对应数据库</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE cyborg;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> cyborg.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;cyborg&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;CYBORG_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> cyborg.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;cyborg&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;CYBORG_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> exit;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建用户和服务，并记住创建cybory用户时输入的密码，用于配置CYBORG_PASS</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br><span class="line">openstack user create --domain default --password-prompt cyborg</span><br><span class="line">openstack role add --project service --user cyborg admin</span><br><span class="line">openstack service create --name cyborg --description &quot;Acceleration Service&quot; accelerator</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用uwsgi部署Cyborg api服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne accelerator public http://controller/accelerator/v2</span><br><span class="line">openstack endpoint create --region RegionOne accelerator internal http://controller/accelerator/v2</span><br><span class="line">openstack endpoint create --region RegionOne accelerator admin http://controller/accelerator/v2</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Cyborg</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-cyborg</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Cyborg</p>
<p> 修改<code>/etc/cyborg/cyborg.conf</code></p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller:<span class="number">5672</span>/</span><br><span class="line"><span class="attr">use_syslog</span> = <span class="literal">False</span></span><br><span class="line"><span class="attr">state_path</span> = /var/lib/cyborg</span><br><span class="line"><span class="attr">debug</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="attr">host_ip</span> = <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://cyborg:CYBORG_DBPASS@controller/cyborg</span><br><span class="line"></span><br><span class="line"><span class="section">[service_catalog]</span></span><br><span class="line"><span class="attr">cafile</span> = /opt/stack/data/ca-bundle.pem</span><br><span class="line"><span class="attr">project_domain_id</span> = default</span><br><span class="line"><span class="attr">user_domain_id</span> = default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">password</span> = CYBORG_PASS</span><br><span class="line"><span class="attr">username</span> = cyborg</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3/</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"></span><br><span class="line"><span class="section">[placement]</span></span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">password</span> = password</span><br><span class="line"><span class="attr">username</span> = PLACEMENT_PASS</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3/</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">auth_section</span> = keystone_authtoken</span><br><span class="line"></span><br><span class="line"><span class="section">[nova]</span></span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">password</span> = NOVA_PASS</span><br><span class="line"><span class="attr">username</span> = nova</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3/</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">auth_section</span> = keystone_authtoken</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">memcached_servers</span> = localhost:<span class="number">11211</span></span><br><span class="line"><span class="attr">signing_dir</span> = /var/cache/cyborg/api</span><br><span class="line"><span class="attr">cafile</span> = /opt/stack/data/ca-bundle.pem</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">password</span> = CYBORG_PASS</span><br><span class="line"><span class="attr">username</span> = cyborg</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3/</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br></pre></td></tr></table></figure>
</li>
<li><p>同步数据库表格</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cyborg-dbsync --config-file /etc/cyborg/cyborg.conf upgrade</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Cyborg服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openstack-cyborg-api openstack-cyborg-conductor openstack-cyborg-agent</span><br><span class="line">systemctl start openstack-cyborg-api openstack-cyborg-conductor openstack-cyborg-agent</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Aodh"><a href="#Aodh" class="headerlink" title="Aodh"></a>Aodh</h4><p>Aodh可以根据由Ceilometer或者Gnocchi收集的监控数据创建告警，并设置触发规则。</p>
<p><strong>Controller节点</strong></p>
<ol>
<li><p>创建数据库。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE aodh;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> aodh.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;aodh&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;AODH_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> aodh.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;aodh&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;AODH_DBPASS&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建服务凭证以及API端点。</p>
<p> 创建服务凭证。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password-prompt aodh</span><br><span class="line">openstack role add --project service --user aodh admin</span><br><span class="line">openstack service create --name aodh --description &quot;Telemetry&quot; alarming</span><br></pre></td></tr></table></figure>

<p> 创建API端点。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne alarming public http://controller:8042</span><br><span class="line">openstack endpoint create --region RegionOne alarming internal http://controller:8042</span><br><span class="line">openstack endpoint create --region RegionOne alarming admin http://controller:8042</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Aodh。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-aodh-api openstack-aodh-evaluator \</span><br><span class="line">openstack-aodh-notifier openstack-aodh-listener \</span><br><span class="line">openstack-aodh-expirer python3-aodhclient</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/aodh/aodh.conf</span><br><span class="line"></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://aodh:AODH_DBPASS@controller/aodh</span><br><span class="line"></span><br><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller</span><br><span class="line"><span class="attr">auth_strategy</span> = keystone</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">memcached_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_id</span> = default</span><br><span class="line"><span class="attr">user_domain_id</span> = default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = aodh</span><br><span class="line"><span class="attr">password</span> = AODH_PASS</span><br><span class="line"></span><br><span class="line"><span class="section">[service_credentials]</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">project_domain_id</span> = default</span><br><span class="line"><span class="attr">user_domain_id</span> = default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = aodh</span><br><span class="line"><span class="attr">password</span> = AODH_PASS</span><br><span class="line"><span class="attr">interface</span> = internalURL</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br></pre></td></tr></table></figure>
</li>
<li><p>同步数据库。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aodh-dbsync</span><br></pre></td></tr></table></figure>
</li>
<li><p>完成安装。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置服务自启</span></span><br><span class="line">systemctl enable openstack-aodh-api.service openstack-aodh-evaluator.service \</span><br><span class="line">openstack-aodh-notifier.service openstack-aodh-listener.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务</span></span><br><span class="line">systemctl start openstack-aodh-api.service openstack-aodh-evaluator.service \</span><br><span class="line">openstack-aodh-notifier.service openstack-aodh-listener.service</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Gnocchi"><a href="#Gnocchi" class="headerlink" title="Gnocchi"></a>Gnocchi</h4><p>Gnocchi是一个开源的时间序列数据库，可以对接Ceilometer。</p>
<p><strong>Controller节点</strong></p>
<ol>
<li><p>创建数据库。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE gnocchi;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> gnocchi.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;gnocchi&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;GNOCCHI_DBPASS&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> gnocchi.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;gnocchi&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;GNOCCHI_DBPASS&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建服务凭证以及API端点。</p>
<p> 创建服务凭证。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password-prompt gnocchi</span><br><span class="line">openstack role add --project service --user gnocchi admin</span><br><span class="line">openstack service create --name gnocchi --description &quot;Metric Service&quot; metric</span><br></pre></td></tr></table></figure>

<p> 创建API端点。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack endpoint create --region RegionOne metric public http://controller:8041</span><br><span class="line">openstack endpoint create --region RegionOne metric internal http://controller:8041</span><br><span class="line">openstack endpoint create --region RegionOne metric admin http://controller:8041</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Gnocchi。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-gnocchi-api openstack-gnocchi-metricd python3-gnocchiclient</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/gnocchi/gnocchi.conf</span><br><span class="line"><span class="section">[api]</span></span><br><span class="line"><span class="attr">auth_mode</span> = keystone</span><br><span class="line"><span class="attr">port</span> = <span class="number">8041</span></span><br><span class="line"><span class="attr">uwsgi_mode</span> = http-socket</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">project_domain_name</span> = Default</span><br><span class="line"><span class="attr">user_domain_name</span> = Default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = gnocchi</span><br><span class="line"><span class="attr">password</span> = GNOCCHI_PASS</span><br><span class="line"><span class="attr">interface</span> = internalURL</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br><span class="line"></span><br><span class="line"><span class="section">[indexer]</span></span><br><span class="line"><span class="attr">url</span> = mysql+pymysql://gnocchi:GNOCCHI_DBPASS@controller/gnocchi</span><br><span class="line"></span><br><span class="line"><span class="section">[storage]</span></span><br><span class="line"><span class="comment"># coordination_url is not required but specifying one will improve</span></span><br><span class="line"><span class="comment"># performance with better workload division across workers.</span></span><br><span class="line"><span class="comment"># coordination_url = redis://controller:6379</span></span><br><span class="line"><span class="attr">file_basepath</span> = /var/lib/gnocchi</span><br><span class="line"><span class="attr">driver</span> = file</span><br></pre></td></tr></table></figure>
</li>
<li><p>同步数据库。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gnocchi-upgrade</span><br></pre></td></tr></table></figure>
</li>
<li><p>完成安装。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置服务自启</span></span><br><span class="line">systemctl enable openstack-gnocchi-api.service openstack-gnocchi-metricd.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务</span></span><br><span class="line">systemctl start openstack-gnocchi-api.service openstack-gnocchi-metricd.service</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Ceilometer"><a href="#Ceilometer" class="headerlink" title="Ceilometer"></a>Ceilometer</h4><p>Ceilometer是OpenStack中负责数据收集的服务。</p>
<p><strong>Controller节点</strong></p>
<ol>
<li><p>创建服务凭证。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain default --password-prompt ceilometer</span><br><span class="line">openstack role add --project service --user ceilometer admin</span><br><span class="line">openstack service create --name ceilometer --description &quot;Telemetry&quot; metering</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Ceilometer软件包。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-ceilometer-notification openstack-ceilometer-central</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置文件&#x2F;etc&#x2F;ceilometer&#x2F;pipeline.yaml。 </p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">publishers:</span></span><br><span class="line">    <span class="comment"># set address of Gnocchi</span></span><br><span class="line">    <span class="comment"># + filter out Gnocchi-related activity meters (Swift driver)</span></span><br><span class="line">    <span class="comment"># + set default archive policy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">gnocchi://?filter_project=service&amp;archive_policy=low</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置文件&#x2F;etc&#x2F;ceilometer&#x2F;ceilometer.conf。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller</span><br><span class="line"></span><br><span class="line"><span class="section">[service_credentials]</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span>/v3</span><br><span class="line"><span class="attr">project_domain_id</span> = default</span><br><span class="line"><span class="attr">user_domain_id</span> = default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = ceilometer</span><br><span class="line"><span class="attr">password</span> = CEILOMETER_PASS</span><br><span class="line"><span class="attr">interface</span> = internalURL</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据库同步。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceilometer-upgrade</span><br></pre></td></tr></table></figure>
</li>
<li><p>完成控制节点Ceilometer安装。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置服务自启</span></span><br><span class="line">systemctl enable openstack-ceilometer-notification.service openstack-ceilometer-central.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务</span></span><br><span class="line">systemctl start openstack-ceilometer-notification.service openstack-ceilometer-central.service</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>Compute节点</strong></p>
<ol>
<li><p>安装Ceilometer软件包。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-ceilometer-compute</span><br><span class="line">dnf install openstack-ceilometer-ipmi       # 可选</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置文件&#x2F;etc&#x2F;ceilometer&#x2F;ceilometer.conf。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller</span><br><span class="line"></span><br><span class="line"><span class="section">[service_credentials]</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">project_domain_id</span> = default</span><br><span class="line"><span class="attr">user_domain_id</span> = default</span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">username</span> = ceilometer</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">password</span> = CEILOMETER_PASS</span><br><span class="line"><span class="attr">interface</span> = internalURL</span><br><span class="line"><span class="attr">region_name</span> = RegionOne</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置文件&#x2F;etc&#x2F;nova&#x2F;nova.conf。</p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">instance_usage_audit</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">instance_usage_audit_period</span> = hour</span><br><span class="line"></span><br><span class="line"><span class="section">[notifications]</span></span><br><span class="line"><span class="attr">notify_on_state_change</span> = vm_and_task_state</span><br><span class="line"></span><br><span class="line"><span class="section">[oslo_messaging_notifications]</span></span><br><span class="line"><span class="attr">driver</span> = messagingv2</span><br></pre></td></tr></table></figure>
</li>
<li><p>完成安装。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openstack-ceilometer-compute.service</span><br><span class="line">systemctl start openstack-ceilometer-compute.service</span><br><span class="line">systemctl enable openstack-ceilometer-ipmi.service         # 可选</span><br><span class="line">systemctl start openstack-ceilometer-ipmi.service          # 可选</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启nova-compute服务</span></span><br><span class="line">systemctl restart openstack-nova-compute.service</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Heat"><a href="#Heat" class="headerlink" title="Heat"></a>Heat</h4><p>Heat是 OpenStack 自动编排服务，基于描述性的模板来编排复合云应用，也称为<code>Orchestration Service</code>。Heat 的各服务一般安装在<code>Controller</code>节点上。</p>
<p><strong>Controller节点</strong></p>
<ol>
<li><p>创建<strong>heat</strong>数据库，并授予<strong>heat</strong>数据库正确的访问权限，替换<strong>HEAT_DBPASS</strong>为合适的密码</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>u root <span class="operator">-</span>p</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">CREATE</span> DATABASE heat;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> heat.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;heat&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;HEAT_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> heat.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;heat&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;HEAT_DBPASS&#x27;</span>;</span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]<span class="operator">&gt;</span> exit;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建服务凭证，创建<strong>heat</strong>用户，并为其增加<strong>admin</strong>角色</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source ~/.admin-openrc</span><br><span class="line"></span><br><span class="line">openstack user create --domain default --password-prompt heat</span><br><span class="line">openstack role add --project service --user heat admin</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<strong>heat</strong>和<strong>heat-cfn</strong>服务及其对应的API端点</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">openstack service create --name heat --description &quot;Orchestration&quot; orchestration</span><br><span class="line">openstack service create --name heat-cfn --description &quot;Orchestration&quot;  cloudformation</span><br><span class="line">openstack endpoint create --region RegionOne orchestration public http://controller:8004/v1/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne orchestration internal http://controller:8004/v1/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne orchestration admin http://controller:8004/v1/%\(tenant_id\)s</span><br><span class="line">openstack endpoint create --region RegionOne cloudformation public http://controller:8000/v1</span><br><span class="line">openstack endpoint create --region RegionOne cloudformation internal http://controller:8000/v1</span><br><span class="line">openstack endpoint create --region RegionOne cloudformation admin http://controller:8000/v1</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建stack管理的额外信息</p>
<p> 创建 <strong>heat</strong> domain</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack domain create --description &quot;Stack projects and users&quot; heat</span><br></pre></td></tr></table></figure>

<p> 在 <strong>heat</strong> domain下创建 <strong>heat_domain_admin</strong> 用户，并记下输入的密码，用于配置下面的<code>HEAT_DOMAIN_PASS</code></p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack user create --domain heat --password-prompt heat_domain_admin</span><br></pre></td></tr></table></figure>

<p> 为 <strong>heat_domain_admin</strong> 用户增加 <strong>admin</strong> 角色</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role add --domain heat --user-domain heat --user heat_domain_admin admin</span><br></pre></td></tr></table></figure>

<p> 创建 <strong>heat_stack_owner</strong> 角色</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role create heat_stack_owner</span><br></pre></td></tr></table></figure>

<p> 创建 <strong>heat_stack_user</strong> 角色</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack role create heat_stack_user</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装软件包</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-heat-api openstack-heat-api-cfn openstack-heat-engine</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件<code>/etc/heat/heat.conf</code></p>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">transport_url</span> = rabbit://openstack:RABBIT_PASS@controller</span><br><span class="line"><span class="attr">heat_metadata_server_url</span> = http://controller:<span class="number">8000</span></span><br><span class="line"><span class="attr">heat_waitcondition_server_url</span> = http://controller:<span class="number">8000</span>/v1/waitcondition</span><br><span class="line"><span class="attr">stack_domain_admin</span> = heat_domain_admin</span><br><span class="line"><span class="attr">stack_domain_admin_password</span> = HEAT_DOMAIN_PASS</span><br><span class="line"><span class="attr">stack_user_domain_name</span> = heat</span><br><span class="line"></span><br><span class="line"><span class="section">[database]</span></span><br><span class="line"><span class="attr">connection</span> = mysql+pymysql://heat:HEAT_DBPASS@controller/heat</span><br><span class="line"></span><br><span class="line"><span class="section">[keystone_authtoken]</span></span><br><span class="line"><span class="attr">www_authenticate_uri</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">memcached_servers</span> = controller:<span class="number">11211</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">project_domain_name</span> = default</span><br><span class="line"><span class="attr">user_domain_name</span> = default</span><br><span class="line"><span class="attr">project_name</span> = service</span><br><span class="line"><span class="attr">username</span> = heat</span><br><span class="line"><span class="attr">password</span> = HEAT_PASS</span><br><span class="line"></span><br><span class="line"><span class="section">[trustee]</span></span><br><span class="line"><span class="attr">auth_type</span> = password</span><br><span class="line"><span class="attr">auth_url</span> = http://controller:<span class="number">5000</span></span><br><span class="line"><span class="attr">username</span> = heat</span><br><span class="line"><span class="attr">password</span> = HEAT_PASS</span><br><span class="line"><span class="attr">user_domain_name</span> = default</span><br><span class="line"></span><br><span class="line"><span class="section">[clients_keystone]</span></span><br><span class="line"><span class="attr">auth_uri</span> = http://controller:<span class="number">5000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化<strong>heat</strong>数据库表</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -s /bin/sh -c &quot;heat-manage db_sync&quot; heat</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动服务</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable openstack-heat-api.service openstack-heat-api-cfn.service openstack-heat-engine.service</span><br><span class="line">systemctl start openstack-heat-api.service openstack-heat-api-cfn.service openstack-heat-engine.service</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Tempest"><a href="#Tempest" class="headerlink" title="Tempest"></a>Tempest</h4><p>Tempest是OpenStack的集成测试服务，如果用户需要全面自动化测试已安装的OpenStack环境的功能,则推荐使用该组件。否则，可以不用安装。</p>
<p><strong>Controller节点</strong>：</p>
<ol>
<li><p>安装Tempest</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install openstack-tempest</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化目录</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tempest init mytest</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd mytest</span><br><span class="line">vi etc/tempest.conf</span><br></pre></td></tr></table></figure>

<p> tempest.conf中需要配置当前OpenStack环境的信息，具体内容可以参考<a target="_blank" rel="noopener" href="https://docs.openstack.org/tempest/latest/sampleconf.html">官方示例</a></p>
</li>
<li><p>执行测试</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tempest run</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装tempest扩展（可选）<br>OpenStack各个服务本身也提供了一些tempest测试包，用户可以安装这些包来丰富tempest的测试内容。在Antelope中，我们提供了Cinder、Glance、Keystone、Ironic、Trove的扩展测试，用户可以执行如下命令进行安装使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install python3-cinder-tempest-plugin python3-glance-tempest-plugin python3-ironic-tempest-plugin python3-keystone-tempest-plugin python3-trove-tempest-plugin</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="基于OpenStack-SIG开发工具oos部署"><a href="#基于OpenStack-SIG开发工具oos部署" class="headerlink" title="基于OpenStack SIG开发工具oos部署"></a>基于OpenStack SIG开发工具oos部署</h2><p><code>oos</code>(openEuler OpenStack SIG)是OpenStack SIG提供的命令行工具。其中<code>oos env</code>系列命令提供了一键部署OpenStack （<code>all in one</code>或三节点<code>cluster</code>）的ansible脚本，用户可以使用该脚本快速部署一套基于 openEuler RPM 的 OpenStack 环境。<code>oos</code>工具支持对接云provider（目前仅支持华为云provider）和主机纳管两种方式来部署 OpenStack 环境，下面以对接华为云部署一套<code>all in one</code>的OpenStack环境为例说明<code>oos</code>工具的使用方法。</p>
<ol>
<li><p>安装<code>oos</code>工具</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openstack-sig-tool</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置对接华为云provider的信息</p>
<p> 打开<code>/usr/local/etc/oos/oos.conf</code>文件，修改配置为您拥有的华为云资源信息，AK&#x2F;SK是用户的华为云登录密钥，其他配置保持默认即可（默认使用新加坡region），需要提前在云上创建对应的资源，包括：</p>
<ul>
<li>一个安全组，名字默认是<code>oos</code></li>
<li>一个openEuler镜像，名称格式是openEuler-%(release)s-%(arch)s，例如<code>openEuler-24.03-sp1-arm64</code></li>
<li>一个VPC，名称是<code>oos_vpc</code></li>
<li>该VPC下面两个子网，名称是<code>oos_subnet1</code>、<code>oos_subnet2</code></li>
</ul>
 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[huaweicloud]</span></span><br><span class="line"><span class="attr">ak</span> = </span><br><span class="line"><span class="attr">sk</span> = </span><br><span class="line"><span class="attr">region</span> = ap-southeast-<span class="number">3</span></span><br><span class="line"><span class="attr">root_volume_size</span> = <span class="number">100</span></span><br><span class="line"><span class="attr">data_volume_size</span> = <span class="number">100</span></span><br><span class="line"><span class="attr">security_group_name</span> = oos</span><br><span class="line"><span class="attr">image_format</span> = openEuler-%%(release)s-%%(arch)s</span><br><span class="line"><span class="attr">vpc_name</span> = oos_vpc</span><br><span class="line"><span class="attr">subnet1_name</span> = oos_subnet1</span><br><span class="line"><span class="attr">subnet2_name</span> = oos_subnet2</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 OpenStack 环境信息</p>
<p> 打开<code>/usr/local/etc/oos/oos.conf</code>文件，根据当前机器环境和需求修改配置。内容如下：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[environment]</span><br><span class="line">mysql_root_password = root</span><br><span class="line">mysql_project_password = root</span><br><span class="line">rabbitmq_password = root</span><br><span class="line">project_identity_password = root</span><br><span class="line">enabled_service = keystone,neutron,cinder,placement,nova,glance,horizon,aodh,ceilometer,cyborg,gnocchi,kolla,heat,swift,trove,tempest</span><br><span class="line">neutron_provider_interface_name = br-ex</span><br><span class="line">default_ext_subnet_range = 10.100.100.0/24</span><br><span class="line">default_ext_subnet_gateway = 10.100.100.1</span><br><span class="line">neutron_dataplane_interface_name = eth1</span><br><span class="line">cinder_block_device = vdb</span><br><span class="line">swift_storage_devices = vdc</span><br><span class="line">swift_hash_path_suffix = ash</span><br><span class="line">swift_hash_path_prefix = has</span><br><span class="line">glance_api_workers = 2</span><br><span class="line">cinder_api_workers = 2</span><br><span class="line">nova_api_workers = 2</span><br><span class="line">nova_metadata_api_workers = 2</span><br><span class="line">nova_conductor_workers = 2</span><br><span class="line">nova_scheduler_workers = 2</span><br><span class="line">neutron_api_workers = 2</span><br><span class="line">horizon_allowed_host = *</span><br><span class="line">kolla_openeuler_plugin = false</span><br></pre></td></tr></table></figure>

<p> <strong>关键配置</strong></p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>enabled_service</td>
<td>安装服务列表，根据用户需求自行删减</td>
</tr>
<tr>
<td>neutron_provider_interface_name</td>
<td>neutron L3网桥名称</td>
</tr>
<tr>
<td>default_ext_subnet_range</td>
<td>neutron私网IP段</td>
</tr>
<tr>
<td>default_ext_subnet_gateway</td>
<td>neutron私网gateway</td>
</tr>
<tr>
<td>neutron_dataplane_interface_name</td>
<td>neutron使用的网卡，推荐使用一张新的网卡，以免和现有网卡冲突，防止all in one主机断连的情况</td>
</tr>
<tr>
<td>cinder_block_device</td>
<td>cinder使用的卷设备名</td>
</tr>
<tr>
<td>swift_storage_devices</td>
<td>swift使用的卷设备名</td>
</tr>
<tr>
<td>kolla_openeuler_plugin</td>
<td>是否启用kolla plugin。设置为True，kolla将支持部署openEuler容器(只在openEuler LTS上支持)</td>
</tr>
</tbody></table>
</li>
<li><p>华为云上面创建一台|openEuler 24.03 LTS SP1的x86_64虚拟机，用于部署<code>all in one</code> 的 OpenStack</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sshpass在`oos <span class="built_in">env</span> create`过程中被使用，用于配置对目标虚拟机的免密访问</span></span><br><span class="line">dnf install sshpass</span><br><span class="line">oos env create -r 24.03-lts-sp1 -f small -a x86 -n test-oos all_in_one</span><br></pre></td></tr></table></figure>

<p> 具体的参数可以使用<code>oos env create --help</code>命令查看</p>
</li>
<li><p>部署OpenStack <code>all in one</code> 环境</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oos env setup test-oos -r antelope</span><br></pre></td></tr></table></figure>

<p> 具体的参数可以使用<code>oos env setup --help</code>命令查看</p>
</li>
<li><p>初始化tempest环境</p>
<p> 如果用户想使用该环境运行tempest测试的话，可以执行命令<code>oos env init</code>，会自动把tempest需要的OpenStack资源自动创建好</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oos env init test-oos</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行tempest测试</p>
<p> 用户可以使用oos自动执行：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oos env test test-oos</span><br></pre></td></tr></table></figure>

<p> 也可以手动登录目标节点，进入根目录下的<code>mytest</code>目录，手动执行<code>tempest run</code></p>
</li>
</ol>
<p>如果是以主机纳管的方式部署 OpenStack 环境，总体逻辑与上文对接华为云时一致，1、3、5、6步操作不变，跳过第2步对华为云provider信息的配置，在第4步改为纳管主机操作。</p>
<p>被纳管的虚机需要保证：</p>
<ul>
<li>至少有一张给oos使用的网卡，名称与配置保持一致，相关配置<code>neutron_dataplane_interface_name</code></li>
<li>至少有一块给oos使用的硬盘，名称与配置保持一致，相关配置<code>cinder_block_device</code></li>
<li>如果要部署swift服务，则需要新增一块硬盘，名称与配置保持一致，相关配置<code>swift_storage_devices</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sshpass在`oos <span class="built_in">env</span> create`过程中被使用，用于配置对目标主机的免密访问</span></span><br><span class="line">dnf install sshpass</span><br><span class="line">oos env manage -r 24.03-lts-sp1 -i TARGET_MACHINE_IP -p TARGET_MACHINE_PASSWD -n test-oos</span><br></pre></td></tr></table></figure>

<p>替换<code>TARGET_MACHINE_IP</code>为目标机ip、<code>TARGET_MACHINE_PASSWD</code>为目标机密码。具体的参数可以使用<code>oos env manage --help</code>命令查看。</p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openstack/" rel="tag">openstack</a></li></ul></div><div class="post-nav"><a class="next" href="/2024/08/07/kolla%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F/">openstack 容器镜像编译和部署</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://example.com"/></form></div><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/AccessOK.png"/></a><p>To be a better one.</p><a class="info-icon" href="accessok@163.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/AccessOK" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Learning-Tools/">Learning Tools</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Learning-Tools/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Learning-Tools/Linux/">Linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Learning-Tools/Linux/Rpm/">Rpm</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Tools/">Tools</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Tools/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Tools/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/Tools/Test/">Test</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/">Openstack</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/Actions/">Actions</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/Actions/Deploy/">Deploy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/Actions/Status/">Status</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/Program/">Program</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Openstack/Program/Status/">Status</a></li></ul></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/openstack/" style="font-size: 15px;">openstack</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Rpm/" style="font-size: 15px;">Rpm</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/Test/" style="font-size: 15px;">Test</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Mysql/" style="font-size: 15px;">Mysql</a> <a href="/tags/%E7%A3%81%E7%9B%98/" style="font-size: 15px;">磁盘</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/03/07/OpenEuler-24.03-LTS-SP1-Antelope/">openEuler openstack Antelope 部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/08/07/kolla%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F/">openstack 容器镜像编译和部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/07/nova%E5%BC%80%E5%8F%91usb%E8%BF%9B%E7%A8%8B/">openstack usb 需求开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/07/openstack%E6%93%8D%E4%BD%9C%E5%8F%8A%E7%8A%B6%E6%80%81/">openstack操作及状态</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/10/%E5%88%9B%E5%BB%BAwindows%E7%9A%84qcow2%E9%95%9C%E5%83%8F/">创建windows的qcow2镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/25/Fio%E6%B5%8B%E8%AF%95%E7%A3%81%E7%9B%98%E8%AF%BB%E5%86%99%E6%80%A7%E8%83%BD/">Fio测试磁盘读写性能</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/25/%E5%9F%BA%E4%BA%8EDebian%E4%BD%BF%E7%94%A8docker/">基于Debian使用Docker</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/25/%E5%B8%B8%E7%94%A8%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B0%8F%E5%B7%A5%E5%85%B7%E9%9B%86%E9%94%A6/">常用性能测试小工具集锦</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/15/Java%E7%8E%AF%E5%A2%83%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE/">java安装配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/12/15/Python%E7%9B%B8%E5%85%B3%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">Python安装配置</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">AccessOK.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>